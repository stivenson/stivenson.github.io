function getSiteScale(){const e=window.innerWidth||1024,t=window.innerHeight||768;return e<=480||t<=600||e<=768&&t<=700?.7:1}function applySiteScaleToDOM(){try{document.documentElement.style.setProperty("--site-scale",String(window.__SITE_SCALE))}catch(e){}}window.USER_CONTEXT={countryCode:"ES",language:"es",isSpanishSpeaker:!0},window.__SITE_SCALE=getSiteScale(),applySiteScaleToDOM();const TRANSLATIONS={es:{privacy_title:"üîí Privacidad y Seguridad",privacy_warn:"No compartas informaci√≥n personal identificable",privacy_gdpr:"Procesamos tu mensaje y emoci√≥n seleccionada para proporcionar t√©cnicas de afrontamiento...",privacy_emergency:"No es un servicio de emergencias. Si est√°s en peligro inmediato, contacta: 112 (Espa√±a) o 911 (EE.UU.).",privacy_button:"Entiendo y Acepto",instructions_title:"Soporte en Crisis TOC",instructions_text:"Selecciona una emoci√≥n o escribe un mensaje para recibir apoyo",chat_header:"Asistente TOC",chat_status_ready:"Listo",chat_status_processing:"Procesando...",chat_status_error:"Error",chat_placeholder:"Escribe tu mensaje...",chat_listening:"Estoy aca para escucharte",chat_analyzing:"analizando...",chat_send:"Enviar",chat_welcome:"¬°Hola! Estoy aqu√≠ para apoyarte. Puedes seleccionar una emoci√≥n o escribirme directamente c√≥mo te sientes.",chat_error_connection:"No se pudo conectar con el servicio. Verifica tu conexi√≥n e intenta de nuevo.",chat_error_generic:"Ocurri√≥ un error al procesar tu mensaje. Por favor, intenta de nuevo.",emotion_selected:"Te sientes:",history_title:"Historial de Conversaci√≥n",history_close:"Cerrar",disclaimer_base:"‚ö†Ô∏è No soy un profesional de salud mental. Si est√°s en peligro inmediato o tienes pensamientos de autolesi√≥n, contacta servicios de emergencia ({emergency}) o busca ayuda profesional inmediatamente.",breathing_inhale:"Inhala...",breathing_hold:"Sost√©n...",breathing_exhale:"Exhala...",breathing_pause:"Pausa...",emotions:{ansioso:{label:"Ansioso",desc:"Nerviosismo, preocupaci√≥n"},obsesivo:{label:"Obsesivo",desc:"Pensamientos repetitivos"},compulsivo:{label:"Compulsivo",desc:"Urgencia de actuar"},calmado:{label:"Calmado",desc:"Tranquilidad, paz"},abrumado:{label:"Abrumado",desc:"Sobrecarga, confusi√≥n"},controlado:{label:"Controlado",desc:"Estabilidad, dominio"}}},en:{privacy_title:"üîí Privacy & Security",privacy_warn:"Do not share personally identifiable information",privacy_gdpr:"We process your message and selected emotion to provide coping techniques...",privacy_emergency:"This is NOT an emergency service. If you are in immediate danger, call 911 (USA) or your local emergency number.",privacy_button:"I Understand & Accept",instructions_title:"OCD Crisis Support",instructions_text:"Select an emotion or write a message to receive support",chat_header:"OCD Assistant",chat_status_ready:"Ready",chat_status_processing:"Processing...",chat_status_error:"Error",chat_placeholder:"Type your message...",chat_listening:"I'm here to listen",chat_analyzing:"analyzing...",chat_send:"Send",chat_welcome:"Hello! I am here to support you. You can select an emotion or write directly how you feel.",chat_error_connection:"Could not connect to the service. Please check your connection and try again.",chat_error_generic:"An error occurred while processing your message. Please try again.",emotion_selected:"You feel:",history_title:"Conversation History",history_close:"Close",disclaimer_base:"‚ö†Ô∏è I am not a mental health professional. If you are in immediate danger or have thoughts of self-harm, contact emergency services ({emergency}) or seek professional help immediately.",breathing_inhale:"Inhale...",breathing_hold:"Hold...",breathing_exhale:"Exhale...",breathing_pause:"Pause...",emotions:{ansioso:{label:"Anxious",desc:"Nervousness, worry"},obsesivo:{label:"Obsessive",desc:"Repetitive thoughts"},compulsivo:{label:"Compulsive",desc:"Urge to act"},calmado:{label:"Calm",desc:"Tranquility, peace"},abrumado:{label:"Overwhelmed",desc:"Overload, confusion"},controlado:{label:"Controlled",desc:"Stability, mastery"}}}};async function detectUserContext(){try{const e=(navigator.language||navigator.userLanguage).split("-")[0].toLowerCase(),t=await fetch("https://ipapi.co/json/").catch(()=>null);if(t&&t.ok){const e=await t.json();USER_CONTEXT.countryCode=e.country_code||"ES"}const a=["ES","MX","CO","AR","PE","VE","CL","EC","GT","CU","BO","DO","HN","PY","SV","NI","CR","PR","UY","GQ"];USER_CONTEXT.isSpanishSpeaker=a.includes(USER_CONTEXT.countryCode)||"es"===e,USER_CONTEXT.language=USER_CONTEXT.isSpanishSpeaker?"es":"en",console.log("User context detected:",USER_CONTEXT),applyUITranslations()}catch(e){console.error("Error detecting user context:",e)}}function t(e){const t=USER_CONTEXT.language;return TRANSLATIONS[t][e]||TRANSLATIONS.es[e]||e}function applyUITranslations(){const e=document.querySelector("#privacy-banner h3");e&&(e.textContent=t("privacy_title"));const a=document.querySelector("#privacy-banner button");a&&(a.textContent=t("privacy_button"));const s=document.querySelector("#instructions h3");s&&(s.textContent=t("instructions_title"));const n=document.querySelector("#instructions p");n&&(n.textContent=t("instructions_text"));const i=document.getElementById("chat-header");i&&(document.getElementById("connection-status"),document.getElementById("selected-emotion"),i.childNodes[0].textContent=t("chat_header")+" ");const r=document.getElementById("chat-input");r&&(r.placeholder=t("chat_placeholder"));const o=document.getElementById("chat-send-btn");o&&(o.textContent=t("chat_send"));const c=document.getElementById("chat-messages");if(c&&c.children.length<=1){const e=c.querySelector(".bot-message .message-content");e&&(e.textContent=t("chat_welcome"))}}window.addEventListener("DOMContentLoaded",detectUserContext);const SUMMARY_KEY="toc_chat_summary";function getChatSummary(){return localStorage.getItem(SUMMARY_KEY)||""}function saveChatSummary(e){e&&(localStorage.setItem(SUMMARY_KEY,e),console.log("üß† Memoria IA actualizada:",e))}function clearChatMemory(){localStorage.removeItem(SUMMARY_KEY),console.log("üßπ Memoria IA borrada")}window.clearChatMemory=clearChatMemory;const PRIVACY_KEY="ocd_support_privacy_accepted";function showPrivacyBanner(){const e=document.getElementById("privacy-overlay"),t=document.getElementById("privacy-banner");e&&t&&(e.style.display="block",t.style.display="flex")}function acceptPrivacy(){localStorage.setItem(PRIVACY_KEY,"true");const e=document.getElementById("privacy-overlay"),t=document.getElementById("privacy-banner");e&&t&&(e.style.display="none",t.style.display="none")}function toggleChat(){const e=document.getElementById("chat-panel");e&&e.classList.toggle("minimized")}window.addEventListener("DOMContentLoaded",()=>{localStorage.getItem(PRIVACY_KEY)||showPrivacyBanner()}),window.acceptPrivacy=acceptPrivacy,window.toggleChat=toggleChat;const API_CONFIG={BASE_URL:"https://stivensonunisimon.app.n8n.cloud",WEBHOOK_PATH:"/webhook/webhook-test"};let EMOTIONS=[{key:"ansioso",label:"Ansioso",color:15965202,description:"Nerviosismo, preocupacion"},{key:"obsesivo",label:"Obsesivo",color:10181046,description:"Pensamientos repetitivos"},{key:"compulsivo",label:"Compulsivo",color:15158332,description:"Urgencia de actuar"},{key:"calmado",label:"Calmado",color:3447003,description:"Tranquilidad, paz"},{key:"abrumado",label:"Abrumado",color:15105570,description:"Sobrecarga, confusion"},{key:"controlado",label:"Controlado",color:2600544,description:"Estabilidad, dominio"}];function translateEmotions(){EMOTIONS=EMOTIONS.map(e=>({...e,label:t("emotions")[e.key]?.label||e.label,description:t("emotions")[e.key]?.desc||e.description}))}let lastBotMessage=null;function getSessionId(){let e=localStorage.getItem("toc_support_session_id");return e||(e="web_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("toc_support_session_id",e)),e}async function sendToN8n(e){const a=getSessionId(),s=getChatSummary(),n={sessionId:a,message:e.message||"",emotion:e.emotion||null,timestamp:(new Date).toISOString(),countryCode:USER_CONTEXT.countryCode,language:USER_CONTEXT.language,chatSummary:s};updateConnectionStatus("processing");try{const e=await fetch(API_CONFIG.BASE_URL+API_CONFIG.WEBHOOK_PATH,{method:"POST",headers:{"Content-Type":"application/json","X-Client":"web"},body:JSON.stringify(n)});if(console.log("Response status:",e.status),!e.ok){const t=await e.text();throw console.error("Error response body:",t),new Error(`HTTP ${e.status}: ${t.substring(0,100)}`)}const t=await e.text();let a;try{a=JSON.parse(t)}catch(e){throw console.error("Error parsing JSON:",e),new Error(`Respuesta no es JSON v√°lido: ${t.substring(0,200)}`)}if(updateConnectionStatus("connected"),a.success&&a.reply)return a.newChatSummary&&saveChatSummary(a.newChatSummary),{success:!0,reply:a.reply,crisisLevel:a.crisisLevel,sessionId:a.sessionId,timestamp:a.timestamp};if(a.error||a.message)return{success:!1,message:a.message||a.response||"Error al procesar el mensaje."};throw new Error("Respuesta inesperada del servidor")}catch(e){return console.error("Error en comunicacion con n8n:",e),updateConnectionStatus("error"),{success:!1,message:t("chat_error_connection")}}}function updateConnectionStatus(e){const a=document.getElementById("connection-status");if(a)switch(a.className="",e){case"connected":a.textContent=t("chat_status_ready"),a.classList.add("connected");break;case"processing":a.textContent=t("chat_status_processing");break;case"error":a.textContent=t("chat_status_error"),a.classList.add("error");break;default:a.textContent=t("chat_status_ready")}}function displayBotResponse(e,t){document.getElementById("chat-messages");let a=e;a=a.replace(/\*\*IMPORTANTE\*\*:.*?(112\/911|emergencia|busca ayuda profesional)[^.]*\.?/gi,"").trim(),a=a.replace(/\n\n\s*$/g,"").trim();const s=t||"none";if(window.phaserGame)try{const e=window.phaserGame.scene.keys.EmotionGameScene;let t,n;if(e.reactToCrisis(s),e.activeUserBubble&&(e.analyzingAnimation&&(e.analyzingAnimation.stop(),e.analyzingAnimation=null),e.tweens.add({targets:e.activeUserBubble,alpha:0,scale:.5,duration:200,onComplete:()=>{e.activeUserBubble&&(e.activeUserBubble.destroy(),e.activeUserBubble=null)}})),e.chatHistory.push({sender:"bot",message:a,timestamp:(new Date).toISOString(),crisisLevel:s}),e.updateHistoryPanel(),e.userInputContainer){const a=e.cameras.main.zoom||1;t=e.userInputContainer.x,n=e.userInputContainer.y-60/a}else{const a=e.cameras.main.width,s=e.cameras.main.height;t=a/2,n=s-140}const{bubble:i}=e.createSpeechBubble(t,n,a,!1);"emergency"===s||"high_distress"===s?(e.startBreathingExercise(),setTimeout(()=>{e.stopBreathingExercise()},2e4)):e.stopBreathingExercise(),setTimeout(()=>{try{if(e.isCompactLandscape()&&e.historyPanelLeft){const t=e.historyPanelLeft.querySelector(".compact-chat-input");t&&t.focus()}else if(e.userInputContainer&&e.userInputContainer.node){const t=e.userInputContainer.node.querySelector(".phaser-chat-input");t&&t.focus()}}catch(e){console.warn("No se pudo hacer focus en el input:",e)}},300)}catch(e){console.error("‚ùå Error al interactuar con Phaser:",e)}else console.warn("‚ö†Ô∏è Phaser game no est√° inicializado");lastBotMessage=a}function displayUserMessage(e){const t=document.getElementById("chat-messages");if(!t)return;const a=document.createElement("div");a.className="chat-message user-message",a.innerHTML=`\n        <div class="message-content">${e}</div>\n        <div class="message-time">${(new Date).toLocaleTimeString(USER_CONTEXT.language,{hour:"2-digit",minute:"2-digit"})}</div>\n    `,t.appendChild(a),t.scrollTop=t.scrollHeight}function showLoading(e=!0){const t=document.getElementById("chat-loading"),a=document.getElementById("chat-send-btn"),s=document.getElementById("chat-input");if(t&&(t.style.display=e?"block":"none"),a&&(a.disabled=e),s&&(s.disabled=e),window.phaserGame)try{const t=window.phaserGame.scene.keys.EmotionGameScene;t&&t.setLoadingState&&t.setLoadingState(e)}catch(e){console.warn("No se pudo actualizar estado de loading en Phaser:",e)}}class EmotionGameScene extends Phaser.Scene{constructor(){super({key:"EmotionGameScene"}),this.character=null,this.clouds=[],this.currentEmotion=null,this.characterParts={},this.ambientParticles=[],this.backgroundGraphics=null,this.breathingCircle=null,this.isBreathingExerciseActive=!1,this.currentCrisisLevel="none",this.activeBubble=null,this.userInputContainer=null,this.chatHistory=[],this.historyModal=null,this.historyPanelLeft=null,this.disclaimerBubble=null,this.activeUserBubble=null,this.analyzingAnimation=null,this.loadingProgressBar=null,this.isLoading=!1}create(){this.applySiteScale();const e=this.cameras.main.width/2,t=this.cameras.main.width<=768?.55*this.cameras.main.height:.48*this.cameras.main.height;this.createBackground(),this.createCharacter(e,t),this.createEmotionClouds(e,t),this.createAmbientParticles(),this.createBreathingOverlay(e,t),this.createDisclaimerBubble(),this.showUserInput(),this.updateResponsiveLayout()}applySiteScale(){const e=this.cameras.main,t=window.__SITE_SCALE||1;e.setZoom(t);const a=e.width/2,s=e.height/2;e.centerOn(a,s),e.setScroll(a-e.width/2,s-e.height/2)}createBackground(){const e=this.cameras.main.width,t=this.cameras.main.height;this.backgroundGraphics=this.add.graphics(),this.updateEnvironment("none");for(let a=0;a<30;a++){const a=Phaser.Math.Between(0,e),s=Phaser.Math.Between(0,t),n=this.add.circle(a,s,Phaser.Math.Between(1,2),16777215,.3);this.tweens.add({targets:n,alpha:{from:.1,to:.5},duration:Phaser.Math.Between(1e3,3e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}updateEnvironment(e){const t=this.cameras.main.width,a=this.cameras.main.height;let s,n,i;switch(this.currentCrisisLevel=e,e){case"emergency":s=4854290,n=2e3,i=.4;break;case"high_distress":s=4004426,n=4e3,i=.3;break;case"ocd_spike":s=1715786,n=6e3,i=.2;break;default:s=4876733,n=1e4,i=.15}this.backgroundGraphics.clear();for(let e=0;e<50;e++){const n=.02,i=15*(50-e);this.backgroundGraphics.fillStyle(s,n),this.backgroundGraphics.fillCircle(t/2,a/2,i)}this.ambientParticles.forEach(e=>{const t=this.tweens.getTweensOf(e)[0];t&&(t.updateTo("duration",Phaser.Math.Between(n,2*n),!0),e.setAlpha(i))})}createCharacter(e,t){this.character=this.add.container(e,t);const a=this.add.graphics();a.fillStyle(7101671,1),a.fillRoundedRect(-40,-30,80,100,20),this.characterParts.body=a;const s=this.add.circle(0,-60,45,16771751);s.setStrokeStyle(3,16632686),this.characterParts.head=s;const n=this.add.graphics();n.fillStyle(2962486,1),n.fillEllipse(0,-95,70,30),n.fillEllipse(-25,-85,25,20),n.fillEllipse(25,-85,25,20),this.characterParts.hair=n;const i=this.add.container(-15,-65),r=this.add.circle(0,0,12,16777215),o=this.add.circle(0,0,6,2962486);i.add([r,o]),this.characterParts.leftEye=i,this.characterParts.leftPupil=o;const c=this.add.container(15,-65),l=this.add.circle(0,0,12,16777215),h=this.add.circle(0,0,6,2962486);c.add([l,h]),this.characterParts.rightEye=c,this.characterParts.rightPupil=h;const d=this.add.rectangle(-15,-82,18,4,2962486);d.setAngle(-5),this.characterParts.leftBrow=d;const p=this.add.rectangle(15,-82,18,4,2962486);p.setAngle(5),this.characterParts.rightBrow=p;const u=this.add.graphics();u.lineStyle(3,2962486),u.beginPath(),u.arc(0,-45,12,0,Math.PI,!1),u.strokePath(),this.characterParts.mouth=u;const m=this.add.rectangle(-55,10,15,50,7101671);m.setAngle(10),this.characterParts.leftArm=m;const y=this.add.rectangle(55,10,15,50,7101671);y.setAngle(-10),this.characterParts.rightArm=y;const g=this.add.circle(-58,35,10,16771751);this.characterParts.leftHand=g;const b=this.add.circle(58,35,10,16771751);this.characterParts.rightHand=b,this.character.add([a,m,y,g,b,s,n,i,c,d,p,u]),this.addIdleAnimation()}addIdleAnimation(){this.tweens.add({targets:this.character,scaleY:1.02,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.time.addEvent({delay:3e3,callback:()=>this.blink(),loop:!0})}blink(){const e=this.characterParts.leftEye.list[0],t=this.characterParts.rightEye.list[0];this.tweens.add({targets:[e,t],scaleY:.1,duration:100,yoyo:!0,ease:"Quad.easeInOut"})}createEmotionClouds(e,t){const a=-Math.PI/2;EMOTIONS.forEach((s,n)=>{const i=a+n*(2*Math.PI/EMOTIONS.length),r=e+170*Math.cos(i),o=t+170*Math.sin(i),c=this.createCloud(r,o,s);this.clouds.push(c)})}createCloud(e,t,a){const s=this.add.container(e,t),n=this.add.graphics();n.fillStyle(16777215,.9),n.fillCircle(0,0,40),n.fillCircle(-25,5,25),n.fillCircle(25,5,25),n.fillCircle(-15,-15,20),n.fillCircle(15,-15,20);const i=this.add.graphics();i.fillStyle(a.color,.3),i.fillCircle(0,0,35);const r=this.add.text(0,0,a.label,{fontSize:"17px",fontFamily:"Segoe UI, system-ui, sans-serif",color:"#2d3436",fontStyle:"bold"}).setOrigin(.5);return s.add([n,i,r]),s.setData("emotion",a),s.setSize(90,70),s.setInteractive({useHandCursor:!0}),s.on("pointerover",()=>{this.tweens.add({targets:s,scale:1.15,duration:200,ease:"Back.easeOut"}),i.clear(),i.fillStyle(a.color,.6),i.fillCircle(0,0,35),this.previewEmotion(a)}),s.on("pointerout",()=>{this.currentEmotion!==a&&(this.tweens.add({targets:s,scale:1,duration:200,ease:"Quad.easeOut"}),i.clear(),i.fillStyle(a.color,.3),i.fillCircle(0,0,35),this.currentEmotion?this.setCharacterEmotion(this.currentEmotion):this.setCharacterNeutral())}),s.on("pointerdown",()=>{this.selectEmotion(a,s)}),this.tweens.add({targets:s,y:t+Phaser.Math.Between(-8,8),duration:Phaser.Math.Between(2e3,3e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut",delay:Phaser.Math.Between(0,1e3)}),s}previewEmotion(e){this.setCharacterEmotion(e)}async selectEmotion(e,a){this.currentEmotion=e,window.currentSelectedEmotion=e,this.tweens.add({targets:a,scale:1.3,duration:150,yoyo:!0,ease:"Quad.easeOut",onComplete:()=>{a.scale=1.15}});const s=document.getElementById("selected-emotion");s&&(s.textContent=`${t("emotion_selected")} ${e.label}`,s.style.display="block"),this.setCharacterEmotion(e),this.disableEmotionClouds();const n=`Me siento ${e.label} (${e.description})`;this.chatHistory.push({sender:"user",message:n,timestamp:(new Date).toISOString()});const i=this.character.x-130,r=this.character.y-60,{bubble:o,secondaryText:c}=this.createSpeechBubble(i,r,n,!0,!0);this.activeUserBubble=o,c&&(this.analyzingAnimation=this.animateAnalyzingDots(c)),showLoading(!0);try{const a=await sendToN8n({message:n,emotion:e});showLoading(!1),a.success&&a.reply?displayBotResponse(a.reply,a.crisisLevel):displayBotResponse(a.message||t("chat_error_generic"),"none")}catch(e){console.error("Error al enviar emoci√≥n:",e),showLoading(!1),displayBotResponse(t("chat_error_generic"),"none")}finally{this.enableEmotionClouds(),this.clouds.forEach(e=>{this.tweens.add({targets:e,scale:1,alpha:1,duration:300})}),s&&(s.style.display="none")}}disableEmotionClouds(){this.clouds.forEach(e=>{e.disableInteractive(),this.tweens.add({targets:e,alpha:.5,duration:200})})}enableEmotionClouds(){this.clouds.forEach(e=>{e.setInteractive({useHandCursor:!0}),this.tweens.add({targets:e,alpha:1,duration:200})})}setCharacterEmotion(e){switch(this.tweens.killTweensOf([this.characterParts.leftBrow,this.characterParts.rightBrow,this.characterParts.leftPupil,this.characterParts.rightPupil,this.characterParts.leftArm,this.characterParts.rightArm,this.character]),this.characterParts.leftBrow.setAngle(-5),this.characterParts.rightBrow.setAngle(5),this.character.setAngle(0),e.key){case"ansioso":this.setAnxiousExpression();break;case"obsesivo":this.setObsessiveExpression();break;case"compulsivo":this.setCompulsiveExpression();break;case"calmado":this.setCalmExpression();break;case"abrumado":this.setOverwhelmedExpression();break;case"controlado":this.setControlledExpression()}}setCharacterNeutral(){this.tweens.killTweensOf([this.characterParts.leftBrow,this.characterParts.rightBrow,this.character]),this.characterParts.leftBrow.setAngle(-5),this.characterParts.rightBrow.setAngle(5),this.character.setAngle(0),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-45,12,0,Math.PI,!1),this.characterParts.mouth.strokePath()}setAnxiousExpression(){this.characterParts.leftBrow.setAngle(15),this.characterParts.rightBrow.setAngle(-15),this.tweens.add({targets:this.character,angle:{from:-2,to:2},duration:100,yoyo:!0,repeat:-1}),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],x:{from:-3,to:3},duration:200,yoyo:!0,repeat:-1}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-40,8,Math.PI,0,!1),this.characterParts.mouth.strokePath()}setObsessiveExpression(){this.characterParts.leftBrow.setAngle(-15),this.characterParts.rightBrow.setAngle(15),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],y:-3,duration:500,yoyo:!0,repeat:-1,ease:"Stepped",easeParams:[2]}),this.tweens.add({targets:this.character,angle:{from:-5,to:5},duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.strokeRect(-8,-48,16,3)}setCompulsiveExpression(){this.characterParts.leftBrow.setAngle(-10),this.characterParts.rightBrow.setAngle(10),this.tweens.add({targets:this.characterParts.leftArm,angle:{from:10,to:30},duration:300,yoyo:!0,repeat:-1}),this.tweens.add({targets:this.characterParts.rightArm,angle:{from:-10,to:-30},duration:300,yoyo:!0,repeat:-1,delay:150}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.fillStyle(2962486,.5),this.characterParts.mouth.fillCircle(0,-45,8)}setCalmExpression(){this.characterParts.leftBrow.setAngle(0),this.characterParts.rightBrow.setAngle(0),this.tweens.add({targets:this.character,y:this.character.y-5,duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],scaleY:.5,duration:1e3,ease:"Sine.easeInOut"}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-50,15,.2,Math.PI-.2,!1),this.characterParts.mouth.strokePath()}setOverwhelmedExpression(){this.characterParts.leftBrow.setAngle(20),this.characterParts.rightBrow.setAngle(-20),this.characterParts.leftBrow.y=-85,this.characterParts.rightBrow.y=-85,this.tweens.add({targets:this.character,angle:{from:-8,to:8},duration:200,yoyo:!0,repeat:-1,ease:"Bounce.easeInOut"}),this.tweens.add({targets:this.characterParts.leftPupil,x:{from:-4,to:4},y:{from:-3,to:3},duration:300,yoyo:!0,repeat:-1}),this.tweens.add({targets:this.characterParts.rightPupil,x:{from:4,to:-4},y:{from:3,to:-3},duration:250,yoyo:!0,repeat:-1}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.fillStyle(2962486,.3),this.characterParts.mouth.fillEllipse(0,-43,15,10)}setControlledExpression(){this.characterParts.leftBrow.setAngle(-3),this.characterParts.rightBrow.setAngle(3),this.tweens.add({targets:this.character,scaleX:1.02,scaleY:1.02,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.characterParts.leftPupil.x=0,this.characterParts.leftPupil.y=0,this.characterParts.rightPupil.x=0,this.characterParts.rightPupil.y=0,this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-48,12,.1,Math.PI-.1,!1),this.characterParts.mouth.strokePath(),this.characterParts.mouth.lineTo(15,-50)}createAmbientParticles(){this.ambientParticles=[];for(let e=0;e<20;e++){const e=Phaser.Math.Between(0,this.cameras.main.width),t=Phaser.Math.Between(0,this.cameras.main.height),a=this.add.circle(e,t,Phaser.Math.Between(2,5),16777215,.15);this.ambientParticles.push(a),this.tweens.add({targets:a,y:t-100,alpha:0,duration:Phaser.Math.Between(5e3,1e4),repeat:-1,onRepeat:()=>{a.x=Phaser.Math.Between(0,this.cameras.main.width),a.y=this.cameras.main.height+20,a.alpha=.15}})}}createBreathingOverlay(e,a){this.breathingCircle=this.add.container(e,a),this.breathingCircle.setAlpha(0);const s=this.add.circle(0,0,100,7101671,.2);s.setStrokeStyle(4,7101671,.5);const n=this.add.circle(0,0,40,7101671,.5),i=this.add.text(0,120,t("breathing_inhale"),{fontSize:"20px",fontFamily:"Segoe UI",color:"#ffffff",backgroundColor:"rgba(0,0,0,0.5)",padding:{x:10,y:5}}).setOrigin(.5);this.breathingCircle.add([s,n,i]),this.breathingCircle.setData("inner",n),this.breathingCircle.setData("text",i)}isCompactLandscape(){const e=window.innerWidth,t=window.innerHeight;return e>t&&t<550}createDisclaimerBubble(){const e=document.getElementById("disclaimer-bubble");e&&e.remove();const a={ES:"112",MX:"911",US:"911",CO:"123",AR:"911",PE:"105",CL:"131"}[USER_CONTEXT.countryCode||"ES"]||"112/911",s=t("disclaimer_base").replace("{emergency}",a),n=document.createElement("div");n.id="disclaimer-bubble",n.innerHTML=s;const i=this.isCompactLandscape();if(n.style.cssText=i?"\n                position: fixed;\n                top: 60px;\n                left: 50%;\n                right: 0;\n                bottom: 0;\n                max-width: none;\n                width: 50%;\n                padding: 15px 20px;\n                background: rgba(255, 248, 220, 0.96);\n                border: 2px solid #e74c3c;\n                border-radius: 0;\n                border-left: 2px solid #e74c3c;\n                font-family: 'Segoe UI', system-ui, sans-serif;\n                font-size: 13px;\n                color: #2d3436;\n                line-height: 1.5;\n                z-index: 9999;\n                box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);\n                overflow-y: auto;\n            ":"\n                position: fixed;\n                top: 60px;\n                right: 10px;\n                max-width: 220px;\n                padding: 10px 14px;\n                background: rgba(255, 248, 220, 0.96);\n                border: 2px solid #e74c3c;\n                border-radius: 10px;\n                font-family: 'Segoe UI', system-ui, sans-serif;\n                font-size: 12px;\n                color: #2d3436;\n                line-height: 1.4;\n                z-index: 9999;\n                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);\n                animation: disclaimerFloat 3s ease-in-out infinite;\n            ",document.body.appendChild(n),!document.getElementById("disclaimer-animation-style")){const e=document.createElement("style");e.id="disclaimer-animation-style",e.textContent="\n                @keyframes disclaimerFloat {\n                    0%, 100% { transform: translateY(0); }\n                    50% { transform: translateY(4px); }\n                }\n                @media (max-width: 480px) {\n                    #disclaimer-bubble:not([data-compact]) {\n                        max-width: 180px;\n                        font-size: 11px;\n                        padding: 8px 10px;\n                        right: 5px;\n                        top: 55px;\n                    }\n                }\n            ",document.head.appendChild(e)}this.disclaimerBubble=n}startBreathingExercise(){if(this.isBreathingExerciseActive)return;this.isBreathingExerciseActive=!0,this.tweens.add({targets:this.breathingCircle,alpha:1,duration:500});const e=this.breathingCircle.getData("inner"),a=this.breathingCircle.getData("text"),s=this.tweens.chain({targets:e,loop:-1,tweens:[{scale:2.5,duration:4e3,ease:"Sine.easeInOut",onStart:()=>a.setText(t("breathing_inhale"))},{scale:2.5,duration:4e3,onStart:()=>a.setText(t("breathing_hold"))},{scale:1,duration:4e3,ease:"Sine.easeInOut",onStart:()=>a.setText(t("breathing_exhale"))},{scale:1,duration:4e3,onStart:()=>a.setText(t("breathing_pause"))}]});this.breathingCircle.setData("chain",s),this.setGuidingExpression()}stopBreathingExercise(){if(!this.isBreathingExerciseActive)return;this.isBreathingExerciseActive=!1;const e=this.breathingCircle.getData("chain");e&&e.stop(),this.tweens.add({targets:this.breathingCircle,alpha:0,duration:500}),this.setCharacterNeutral()}animateAnalyzingDots(e){if(!e)return{stop:()=>{}};let t=0;const a=this.time.addEvent({delay:400,callback:()=>{t=(t+1)%4;const a=".".repeat(t);e.setText("analizando"+a)},loop:!0});return{stop:()=>{a&&a.remove()}}}createSpeechBubble(e,t,a,s=!1,n=!1){!s&&this.activeBubble&&this.activeBubble.destroy();const i=this.cameras.main.width,r=i<=480,o=r?Math.min(280,i-40):220,c=this.add.text(0,0,a,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:r?"16px":"17px",wordWrap:{width:o-30}});let l=Math.max(60,c.height+30),h=0;if(s&&n){const e=this.add.text(0,0,"analizando...",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"15px"});h=e.height+6,l+=h,e.destroy()}c.destroy();let d=e;if(s){const t=10,a=i-o-10;d=Math.max(t,Math.min(e,a))}else{d=i/2-o/2;const e=10,t=i-o-10;d=Math.max(e,Math.min(d,t))}const p=this.add.container(d,t),u=this.add.graphics();u.fillStyle(16777215,1),u.lineStyle(2,7101671,1),u.fillRoundedRect(0,0,o,l,15),u.strokeRoundedRect(0,0,o,l,15),u.beginPath(),s?(u.moveTo(o-30,l),u.lineTo(o-15,l+15),u.lineTo(o-5,l)):(u.moveTo(o/2-15,l),u.lineTo(o/2,l+15),u.lineTo(o/2+15,l)),u.closePath(),u.fillPath(),u.strokePath();const m=this.add.text(15,15,a,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:r?"16px":"17px",color:"#2d3436",align:"left",wordWrap:{width:o-30}});let y=null;if(s&&n){const e=15+m.height+6;y=this.add.text(15,e,"analizando",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"15px",color:"#0088CC",align:"left",fontStyle:"bold"}),p.add([u,m,y])}else p.add([u,m]);return p.setAlpha(0),p.setScale(.5),this.tweens.add({targets:p,alpha:1,scale:1,y:t-l-15-5,duration:300,ease:"Back.easeOut"}),s||(this.activeBubble=p),{bubble:p,secondaryText:y}}showUserInput(){const e=()=>{const e=this.cameras.main,t=e.width,a=e.height,s=this.sys?.game?.canvas?.getBoundingClientRect?.(),n="undefined"!=typeof window&&window.visualViewport?window.visualViewport:null,i=s&&s.width?s.width:n&&n.width?n.width:"undefined"!=typeof window&&window.innerWidth||t,r=s&&s.height?s.height:n&&n.height?n.height:"undefined"!=typeof window&&window.innerHeight||a,o=i<=768,c=i>r&&r<550,l=e.zoom||1;if(c){let t=350,a=56;if(this.userInputContainer&&this.userInputContainer.node)try{const e=this.userInputContainer.node.getBoundingClientRect();e.width>0&&(t=e.width),e.height>0&&(a=e.height)}catch(e){}const s=20,n=10;let i=50;try{const e="undefined"!=typeof document?document.getElementById("footer"):null;if(e){const t=e.getBoundingClientRect();t&&t.height&&(i=t.height)}}catch(e){}const o=s+t/2,c=r-i-n-a/2;return{centerX:e.scrollX+o/l,centerY:e.scrollY+c/l}}return{centerX:t/2,centerY:o?a-80:a-120}};if(this.userInputContainer){const{centerX:t,centerY:a}=e();return void this.userInputContainer.setPosition(t,a)}const{centerX:a,centerY:s}=e(),n=`\n            <div class="phaser-input-wrapper">\n                <div class="phaser-loading-bar" style="display: none;">\n                    <div class="phaser-loading-dots">\n                        <span></span><span></span><span></span>\n                    </div>\n                </div>\n                <div class="phaser-input-container">\n                    <button class="phaser-history-btn" title="Ver historial">üìú</button>\n                    <input type="text" class="phaser-chat-input" placeholder="${t("chat_listening")}" />\n                    <button class="phaser-send-btn">${t("chat_send")}</button>\n                </div>\n            </div>\n        `;this.userInputContainer=this.add.dom(a,s).createFromHTML(n);const i=this.userInputContainer.node,r=i.querySelector(".phaser-chat-input"),o=i.querySelector(".phaser-send-btn"),c=i.querySelector(".phaser-history-btn"),l=()=>{const e=r.value.trim();e&&(this.handleUserChat(e),r.value="")};o.addEventListener("click",l),r.addEventListener("keypress",e=>{"Enter"===e.key&&l()}),c.addEventListener("click",()=>{this.showHistoryModal()}),setTimeout(()=>r.focus(),100)}createHistoryPanel(){const e=document.getElementById("history-panel-left");e&&e.remove();const a=document.createElement("div");a.id="history-panel-left";const s=this.generateHistoryHTML(),n=`\n            <div class="compact-input-wrapper">\n                <div class="compact-loading-bar" style="display: none;">\n                    <div class="compact-loading-dots">\n                        <span></span><span></span><span></span>\n                    </div>\n                </div>\n                <div class="compact-input-container">\n                    <button class="compact-history-btn" title="Ver historial">üìú</button>\n                    <input type="text" class="compact-chat-input" placeholder="${t("chat_listening")}" />\n                    <button class="compact-send-btn">${t("chat_send")}</button>\n                </div>\n            </div>\n        `;if(a.innerHTML=`\n            <div class="history-panel-header">\n                <h3>${t("history_title")||"Historial de Conversaci√≥n"}</h3>\n            </div>\n            <div class="history-panel-content">\n                ${s}\n            </div>\n            ${n}\n        `,a.style.cssText="\n            position: fixed;\n            top: 60px;\n            left: 0;\n            width: 50%;\n            bottom: 0;\n            background: rgba(255, 255, 255, 0.98);\n            border-right: 2px solid #6c5ce7;\n            z-index: 9998;\n            display: flex;\n            flex-direction: column;\n            overflow: hidden;\n        ",!document.getElementById("history-panel-styles")){const e=document.createElement("style");e.id="history-panel-styles",e.textContent="\n                #history-panel-left .history-panel-header {\n                    padding: 15px 20px;\n                    background: linear-gradient(135deg, #6c5ce7 0%, #5f4bd8 100%);\n                    color: white;\n                    border-bottom: 2px solid #5a4bc7;\n                    flex-shrink: 0;\n                }\n                #history-panel-left .history-panel-header h3 {\n                    margin: 0;\n                    font-family: 'Segoe UI', system-ui, sans-serif;\n                    font-size: 18px;\n                    font-weight: 600;\n                }\n                #history-panel-left .history-panel-content {\n                    flex: 1;\n                    overflow-y: auto;\n                    padding: 15px;\n                    background: #f9f9f9;\n                    min-height: 0;\n                }\n                #history-panel-left .history-panel-content::-webkit-scrollbar {\n                    width: 8px;\n                }\n                #history-panel-left .history-panel-content::-webkit-scrollbar-track {\n                    background: #f1f1f1;\n                }\n                #history-panel-left .history-panel-content::-webkit-scrollbar-thumb {\n                    background: #6c5ce7;\n                    border-radius: 10px;\n                }\n                #history-panel-left .history-panel-content::-webkit-scrollbar-thumb:hover {\n                    background: #5a4bc7;\n                }\n                #history-panel-left .compact-input-wrapper {\n                    flex-shrink: 0;\n                    padding: 10px 15px;\n                    background: white;\n                    border-top: 2px solid #6c5ce7;\n                    display: flex;\n                    flex-direction: column;\n                    gap: 8px;\n                }\n                #history-panel-left .compact-input-container {\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                    background: rgba(255, 255, 255, 0.95);\n                    padding: 8px 12px;\n                    border-radius: 25px;\n                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);\n                    border: 2px solid #6c5ce7;\n                }\n                #history-panel-left .compact-chat-input {\n                    border: none;\n                    background: transparent;\n                    outline: none;\n                    font-family: 'Segoe UI', system-ui, sans-serif;\n                    font-size: 14px;\n                    flex: 1;\n                    padding: 6px 4px;\n                    color: #2d3436;\n                }\n                #history-panel-left .compact-chat-input::placeholder {\n                    color: #999;\n                }\n                #history-panel-left .compact-send-btn {\n                    background: #6c5ce7;\n                    color: white;\n                    border: none;\n                    padding: 6px 14px;\n                    border-radius: 18px;\n                    cursor: pointer;\n                    font-weight: 600;\n                    font-size: 12px;\n                    transition: background 0.2s;\n                }\n                #history-panel-left .compact-send-btn:hover {\n                    background: #5a4bc7;\n                }\n                #history-panel-left .compact-send-btn:disabled {\n                    background: #bdc3c7;\n                    cursor: not-allowed;\n                }\n                #history-panel-left .compact-history-btn {\n                    background: #f0f0f0;\n                    color: #6c5ce7;\n                    border: 2px solid #6c5ce7;\n                    width: 34px;\n                    height: 34px;\n                    border-radius: 50%;\n                    cursor: pointer;\n                    font-size: 14px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    transition: background 0.2s;\n                }\n                #history-panel-left .compact-history-btn:hover {\n                    background: #e0e0e0;\n                }\n                #history-panel-left .compact-loading-bar {\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    gap: 5px;\n                    background: rgba(108, 92, 231, 0.15);\n                    padding: 6px 15px;\n                    border-radius: 12px;\n                    border: 2px solid #6c5ce7;\n                }\n                #history-panel-left .compact-loading-dots {\n                    display: flex;\n                    gap: 5px;\n                }\n                #history-panel-left .compact-loading-dots span {\n                    width: 8px;\n                    height: 8px;\n                    background: #6c5ce7;\n                    border-radius: 50%;\n                    animation: compactLoadingBounce 1.4s infinite ease-in-out both;\n                }\n                #history-panel-left .compact-loading-dots span:nth-child(1) { animation-delay: -0.32s; }\n                #history-panel-left .compact-loading-dots span:nth-child(2) { animation-delay: -0.16s; }\n                #history-panel-left .compact-loading-dots span:nth-child(3) { animation-delay: 0s; }\n                @keyframes compactLoadingBounce {\n                    0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }\n                    40% { transform: scale(1); opacity: 1; }\n                }\n            ",document.head.appendChild(e)}document.body.appendChild(a),this.historyPanelLeft=a;const i=a.querySelector(".compact-chat-input"),r=a.querySelector(".compact-send-btn"),o=a.querySelector(".compact-history-btn"),c=a.querySelector(".compact-loading-bar"),l=()=>{const e=i.value.trim();e&&(this.handleUserChat(e),i.value="")};r&&r.addEventListener("click",l),i&&(i.addEventListener("keypress",e=>{"Enter"===e.key&&l()}),setTimeout(()=>i.focus(),100)),o&&o.addEventListener("click",()=>{this.showHistoryModal()}),this.compactInput=i,this.compactSendBtn=r,this.compactLoadingBar=c}removeHistoryPanel(){const e=document.getElementById("history-panel-left");e&&(e.remove(),this.historyPanelLeft=null)}updateHistoryPanel(){if(this.historyPanelLeft){const e=this.historyPanelLeft.querySelector(".history-panel-content");e&&(e.innerHTML=this.generateHistoryHTML(),setTimeout(()=>{e.scrollTop=e.scrollHeight},10))}}updateResponsiveLayout(){const e=this.isCompactLandscape(),t=document.getElementById("disclaimer-bubble");if(e)this.historyPanelLeft?this.updateHistoryPanel():this.createHistoryPanel(),this.userInputContainer&&this.userInputContainer.node&&(this.userInputContainer.node.style.display="none"),t&&(t.style.cssText="\n                    position: fixed;\n                    top: 60px;\n                    left: 50%;\n                    right: 0;\n                    bottom: 0;\n                    max-width: none;\n                    width: 50%;\n                    padding: 15px 20px;\n                    background: rgba(255, 248, 220, 0.96);\n                    border: 2px solid #e74c3c;\n                    border-radius: 0;\n                    border-left: 2px solid #e74c3c;\n                    font-family: 'Segoe UI', system-ui, sans-serif;\n                    font-size: 13px;\n                    color: #2d3436;\n                    line-height: 1.5;\n                    z-index: 9999;\n                    box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);\n                    overflow-y: auto;\n                ");else{this.removeHistoryPanel(),this.userInputContainer&&this.userInputContainer.node&&(this.userInputContainer.node.style.display="");try{this.showUserInput()}catch(e){}t&&(t.style.cssText="\n                    position: fixed;\n                    top: 60px;\n                    right: 10px;\n                    max-width: 220px;\n                    padding: 10px 14px;\n                    background: rgba(255, 248, 220, 0.96);\n                    border: 2px solid #e74c3c;\n                    border-radius: 10px;\n                    font-family: 'Segoe UI', system-ui, sans-serif;\n                    font-size: 12px;\n                    color: #2d3436;\n                    line-height: 1.4;\n                    z-index: 9999;\n                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);\n                    animation: disclaimerFloat 3s ease-in-out infinite;\n                ")}}setLoadingState(e){if(this.isLoading=e,this.isCompactLandscape()&&this.historyPanelLeft){const a=this.historyPanelLeft.querySelector(".compact-chat-input"),s=this.historyPanelLeft.querySelector(".compact-send-btn"),n=this.historyPanelLeft.querySelector(".compact-loading-bar");e?(n&&(n.style.display="flex"),a&&(a.placeholder=t("chat_analyzing"),a.disabled=!0),s&&(s.disabled=!0,s.style.opacity="0.5",s.style.cursor="not-allowed")):(n&&(n.style.display="none"),a&&(a.placeholder=t("chat_listening"),a.disabled=!1),s&&(s.disabled=!1,s.style.opacity="1",s.style.cursor="pointer"))}else if(this.userInputContainer){const a=this.userInputContainer.node,s=a.querySelector(".phaser-chat-input"),n=a.querySelector(".phaser-send-btn"),i=a.querySelector(".phaser-loading-bar");e?(i&&(i.style.display="flex"),s&&(s.placeholder=t("chat_analyzing"),s.disabled=!0),n&&(n.disabled=!0,n.style.opacity="0.5",n.style.cursor="not-allowed")):(i&&(i.style.display="none"),s&&(s.placeholder=t("chat_listening"),s.disabled=!1),n&&(n.disabled=!1,n.style.opacity="1",n.style.cursor="pointer"))}}handleUserChat(e){this.chatHistory.push({sender:"user",message:e,timestamp:(new Date).toISOString()}),this.updateHistoryPanel();const t=this.character.x-130,a=this.character.y-60,{bubble:s,secondaryText:n}=this.createSpeechBubble(t,a,e,!0,!0);this.activeUserBubble=s,n&&(this.analyzingAnimation=this.animateAnalyzingDots(n)),window.sendChatMessageFromPhaser(e)}reactToCrisis(e){this.updateEnvironment(e),"emergency"===e||"high_distress"===e?this.setListeningExpression():"none"===e&&this.setCalmExpression()}setListeningExpression(){this.tweens.killTweensOf(this.character),this.tweens.add({targets:this.character,y:this.character.y+10,scaleX:1.05,duration:1e3,ease:"Sine.easeOut"}),this.characterParts.leftBrow.setAngle(10),this.characterParts.rightBrow.setAngle(-10)}setGuidingExpression(){this.tweens.killTweensOf([this.characterParts.leftArm,this.characterParts.rightArm]),this.tweens.add({targets:[this.characterParts.leftArm,this.characterParts.rightArm],angle:{from:10,to:-20},duration:4e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}showHistoryModal(){if(this.historyModal)return;const e=this.cameras.main.width/2,a=this.cameras.main.height/2;this.historyModal=this.add.container(e,a);const s=this.add.graphics();s.fillStyle(0,.7),s.fillRect(-this.cameras.main.width/2,-this.cameras.main.height/2,this.cameras.main.width,this.cameras.main.height),s.setInteractive(new Phaser.Geom.Rectangle(-this.cameras.main.width/2,-this.cameras.main.height/2,this.cameras.main.width,this.cameras.main.height),Phaser.Geom.Rectangle.Contains);const n=this.add.graphics();n.fillStyle(16777215,1),n.lineStyle(3,7101671,1),n.fillRoundedRect(-200,-250,400,500,20),n.strokeRoundedRect(-200,-250,400,500,20);const i=this.add.text(0,-225,t("history_title")||"Historial de Conversaci√≥n",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"20px",fontStyle:"bold",color:"#6c5ce7",align:"center"});i.setOrigin(.5);const r=this.generateHistoryHTML(),o=this.add.dom(0,20).createFromHTML(`\n            <div class="phaser-history-content">\n                ${r}\n            </div>\n        `),c=this.add.text(0,210,t("history_close")||"Cerrar",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"16px",color:"#ffffff",backgroundColor:"#6c5ce7",padding:{x:20,y:10}});c.setOrigin(.5),c.setInteractive({useHandCursor:!0}),c.on("pointerdown",()=>{this.closeHistoryModal()}),c.on("pointerover",()=>{c.setStyle({backgroundColor:"#5a4bc7"})}),c.on("pointerout",()=>{c.setStyle({backgroundColor:"#6c5ce7"})}),this.historyModal.add([s,n,i,o,c]),this.historyModal.setAlpha(0),this.historyModal.setScale(.8),this.tweens.add({targets:this.historyModal,alpha:1,scale:1,duration:300,ease:"Back.easeOut"})}closeHistoryModal(){this.historyModal&&this.tweens.add({targets:this.historyModal,alpha:0,scale:.8,duration:200,ease:"Back.easeIn",onComplete:()=>{this.historyModal.destroy(),this.historyModal=null}})}generateHistoryHTML(){if(0===this.chatHistory.length)return'<p style="text-align: center; color: #999; padding: 20px;">No hay mensajes todav√≠a</p>';let e="";return this.chatHistory.forEach((t,a)=>{const s=new Date(t.timestamp).toLocaleTimeString(USER_CONTEXT.language,{hour:"2-digit",minute:"2-digit"}),n="user"===t.sender?"T√∫":"Asistente",i="user"===t.sender?"history-user":"history-bot",r=t.crisisLevel&&"none"!==t.crisisLevel?`<span class="crisis-tag">${t.crisisLevel}</span>`:"";e+=`\n                <div class="history-entry ${i}">\n                    <div class="history-header">\n                        <strong>${n}</strong> ${r}\n                        <span class="history-time">${s}</span>\n                    </div>\n                    <div class="history-message">${t.message}</div>\n                </div>\n            `}),e}}function initEmotionGame(e="game-container",t=window.innerWidth,a=window.innerHeight){const s={type:Phaser.AUTO,width:t,height:a,parent:e,backgroundColor:"#1a1a2e",dom:{createContainer:!0},scene:EmotionGameScene,scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH}};return new Phaser.Game(s)}window.addEventListener("DOMContentLoaded",async()=>{await detectUserContext(),translateEmotions(),window.phaserGame=initEmotionGame();const e=document.getElementById("chat-input"),a=document.getElementById("chat-send-btn");async function s(a=null){const s=null!==a?a:e.value.trim();if(!s)return;null===a&&e&&(e.value=""),showLoading(!0);let n=s;lastBotMessage&&(n=`[√öltimo mensaje del asistente: "${lastBotMessage}"]\n\nRespuesta del usuario: ${s}`,lastBotMessage=null);try{const e=await sendToN8n({message:n,emotion:null});e.success&&e.reply?displayBotResponse(e.reply,e.crisisLevel):displayBotResponse(e.message||t("chat_error_generic"),"none")}catch(e){console.error("Error inesperado al enviar mensaje:",e),displayBotResponse(t("chat_error_generic"),"none")}finally{showLoading(!1)}}window.sendChatMessageFromPhaser=e=>s(e),a&&a.addEventListener("click",s),e&&e.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),s())})}),window.addEventListener("resize",()=>{window.__SITE_SCALE=getSiteScale(),applySiteScaleToDOM();try{const e=window.phaserGame?.scene?.keys?.EmotionGameScene;e&&"function"==typeof e.applySiteScale&&e.applySiteScale(),e&&"function"==typeof e.updateResponsiveLayout&&e.updateResponsiveLayout()}catch(e){}});try{window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{try{const e=window.phaserGame?.scene?.keys?.EmotionGameScene;e&&"function"==typeof e.updateResponsiveLayout&&e.updateResponsiveLayout()}catch(e){}})}catch(e){}window.currentSelectedEmotion=null;