function getSiteScale(){const e=window.innerWidth||1024,t=window.innerHeight||768;return e<=480||t<=600||e<=768&&t<=700?.7:1}function applySiteScaleToDOM(){try{document.documentElement.style.setProperty("--site-scale",String(window.__SITE_SCALE))}catch(e){}}window.USER_CONTEXT={countryCode:"ES",language:"es",isSpanishSpeaker:!0},window.__SITE_SCALE=getSiteScale(),applySiteScaleToDOM();const TRANSLATIONS={es:{privacy_title:"üîí Privacidad y Seguridad",privacy_warn:"No compartas informaci√≥n personal identificable",privacy_gdpr:"Procesamos tu mensaje y emoci√≥n seleccionada para proporcionar t√©cnicas de afrontamiento...",privacy_emergency:"No es un servicio de emergencias. Si est√°s en peligro inmediato, contacta: 112 (Espa√±a) o 911 (EE.UU.).",privacy_button:"Entiendo y Acepto",instructions_title:"Soporte en Crisis TOC",instructions_text:"Selecciona una emoci√≥n o escribe un mensaje para recibir apoyo",chat_header:"Asistente TOC",chat_status_ready:"Listo",chat_status_processing:"Procesando...",chat_status_error:"Error",chat_placeholder:"Escribe tu mensaje...",chat_listening:"Estoy aca para escucharte",chat_analyzing:"analizando...",chat_send:"Enviar",chat_welcome:"¬°Hola! Estoy aqu√≠ para apoyarte. Puedes seleccionar una emoci√≥n o escribirme directamente c√≥mo te sientes.",chat_error_connection:"No se pudo conectar con el servicio. Verifica tu conexi√≥n e intenta de nuevo.",chat_error_generic:"Ocurri√≥ un error al procesar tu mensaje. Por favor, intenta de nuevo.",emotion_selected:"Te sientes:",history_title:"Historial de Conversaci√≥n",history_close:"Cerrar",disclaimer_base:"‚ö†Ô∏è No soy un profesional de salud mental. Si est√°s en peligro inmediato o tienes pensamientos de autolesi√≥n, contacta servicios de emergencia ({emergency}) o busca ayuda profesional inmediatamente.",breathing_inhale:"Inhala...",breathing_hold:"Sost√©n...",breathing_exhale:"Exhala...",breathing_pause:"Pausa...",emotions:{ansioso:{label:"Ansioso",desc:"Nerviosismo, preocupaci√≥n"},obsesivo:{label:"Obsesivo",desc:"Pensamientos repetitivos"},compulsivo:{label:"Compulsivo",desc:"Urgencia de actuar"},calmado:{label:"Calmado",desc:"Tranquilidad, paz"},abrumado:{label:"Abrumado",desc:"Sobrecarga, confusi√≥n"},controlado:{label:"Controlado",desc:"Estabilidad, dominio"}}},en:{privacy_title:"üîí Privacy & Security",privacy_warn:"Do not share personally identifiable information",privacy_gdpr:"We process your message and selected emotion to provide coping techniques...",privacy_emergency:"This is NOT an emergency service. If you are in immediate danger, call 911 (USA) or your local emergency number.",privacy_button:"I Understand & Accept",instructions_title:"OCD Crisis Support",instructions_text:"Select an emotion or write a message to receive support",chat_header:"OCD Assistant",chat_status_ready:"Ready",chat_status_processing:"Processing...",chat_status_error:"Error",chat_placeholder:"Type your message...",chat_listening:"I'm here to listen",chat_analyzing:"analyzing...",chat_send:"Send",chat_welcome:"Hello! I am here to support you. You can select an emotion or write directly how you feel.",chat_error_connection:"Could not connect to the service. Please check your connection and try again.",chat_error_generic:"An error occurred while processing your message. Please try again.",emotion_selected:"You feel:",history_title:"Conversation History",history_close:"Close",disclaimer_base:"‚ö†Ô∏è I am not a mental health professional. If you are in immediate danger or have thoughts of self-harm, contact emergency services ({emergency}) or seek professional help immediately.",breathing_inhale:"Inhale...",breathing_hold:"Hold...",breathing_exhale:"Exhale...",breathing_pause:"Pause...",emotions:{ansioso:{label:"Anxious",desc:"Nervousness, worry"},obsesivo:{label:"Obsessive",desc:"Repetitive thoughts"},compulsivo:{label:"Compulsive",desc:"Urge to act"},calmado:{label:"Calm",desc:"Tranquility, peace"},abrumado:{label:"Overwhelmed",desc:"Overload, confusion"},controlado:{label:"Controlled",desc:"Stability, mastery"}}}};async function detectUserContext(){try{const e=(navigator.language||navigator.userLanguage).split("-")[0].toLowerCase(),t=await fetch("https://ipapi.co/json/").catch(()=>null);if(t&&t.ok){const e=await t.json();USER_CONTEXT.countryCode=e.country_code||"ES"}const a=["ES","MX","CO","AR","PE","VE","CL","EC","GT","CU","BO","DO","HN","PY","SV","NI","CR","PR","UY","GQ"];USER_CONTEXT.isSpanishSpeaker=a.includes(USER_CONTEXT.countryCode)||"es"===e,USER_CONTEXT.language=USER_CONTEXT.isSpanishSpeaker?"es":"en",console.log("User context detected:",USER_CONTEXT),applyUITranslations()}catch(e){console.error("Error detecting user context:",e)}}function t(e){const t=USER_CONTEXT.language;return TRANSLATIONS[t][e]||TRANSLATIONS.es[e]||e}function applyUITranslations(){const e=document.querySelector("#privacy-banner h3");e&&(e.textContent=t("privacy_title"));const a=document.querySelector("#privacy-banner button");a&&(a.textContent=t("privacy_button"));const s=document.querySelector("#instructions h3");s&&(s.textContent=t("instructions_title"));const r=document.querySelector("#instructions p");r&&(r.textContent=t("instructions_text"));const i=document.getElementById("chat-header");i&&(document.getElementById("connection-status"),document.getElementById("selected-emotion"),i.childNodes[0].textContent=t("chat_header")+" ");const n=document.getElementById("chat-input");n&&(n.placeholder=t("chat_placeholder"));const o=document.getElementById("chat-send-btn");o&&(o.textContent=t("chat_send"));const c=document.getElementById("chat-messages");if(c&&c.children.length<=1){const e=c.querySelector(".bot-message .message-content");e&&(e.textContent=t("chat_welcome"))}}window.addEventListener("DOMContentLoaded",detectUserContext);const SUMMARY_KEY="toc_chat_summary";function getChatSummary(){return localStorage.getItem(SUMMARY_KEY)||""}function saveChatSummary(e){e&&(localStorage.setItem(SUMMARY_KEY,e),console.log("üß† Memoria IA actualizada:",e))}function clearChatMemory(){localStorage.removeItem(SUMMARY_KEY),console.log("üßπ Memoria IA borrada")}window.clearChatMemory=clearChatMemory;const PRIVACY_KEY="ocd_support_privacy_accepted";function showPrivacyBanner(){const e=document.getElementById("privacy-overlay"),t=document.getElementById("privacy-banner");e&&t&&(e.style.display="block",t.style.display="flex")}function acceptPrivacy(){localStorage.setItem(PRIVACY_KEY,"true");const e=document.getElementById("privacy-overlay"),t=document.getElementById("privacy-banner");e&&t&&(e.style.display="none",t.style.display="none")}function toggleChat(){const e=document.getElementById("chat-panel");e&&e.classList.toggle("minimized")}window.addEventListener("DOMContentLoaded",()=>{localStorage.getItem(PRIVACY_KEY)||showPrivacyBanner()}),window.acceptPrivacy=acceptPrivacy,window.toggleChat=toggleChat;const API_CONFIG={BASE_URL:"https://stivensonunisimon.app.n8n.cloud",WEBHOOK_PATH:"/webhook/webhook-test"};let EMOTIONS=[{key:"ansioso",label:"Ansioso",color:15965202,description:"Nerviosismo, preocupacion"},{key:"obsesivo",label:"Obsesivo",color:10181046,description:"Pensamientos repetitivos"},{key:"compulsivo",label:"Compulsivo",color:15158332,description:"Urgencia de actuar"},{key:"calmado",label:"Calmado",color:3447003,description:"Tranquilidad, paz"},{key:"abrumado",label:"Abrumado",color:15105570,description:"Sobrecarga, confusion"},{key:"controlado",label:"Controlado",color:2600544,description:"Estabilidad, dominio"}];function translateEmotions(){EMOTIONS=EMOTIONS.map(e=>({...e,label:t("emotions")[e.key]?.label||e.label,description:t("emotions")[e.key]?.desc||e.description}))}let lastBotMessage=null;function getSessionId(){let e=localStorage.getItem("toc_support_session_id");return e||(e="web_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("toc_support_session_id",e)),e}async function sendToN8n(e){const a=getSessionId(),s=getChatSummary(),r={sessionId:a,message:e.message||"",emotion:e.emotion||null,timestamp:(new Date).toISOString(),countryCode:USER_CONTEXT.countryCode,language:USER_CONTEXT.language,chatSummary:s};updateConnectionStatus("processing");try{const e=await fetch(API_CONFIG.BASE_URL+API_CONFIG.WEBHOOK_PATH,{method:"POST",headers:{"Content-Type":"application/json","X-Client":"web"},body:JSON.stringify(r)});if(console.log("Response status:",e.status),!e.ok){const t=await e.text();throw console.error("Error response body:",t),new Error(`HTTP ${e.status}: ${t.substring(0,100)}`)}const t=await e.text();let a;try{a=JSON.parse(t)}catch(e){throw console.error("Error parsing JSON:",e),new Error(`Respuesta no es JSON v√°lido: ${t.substring(0,200)}`)}if(updateConnectionStatus("connected"),a.success&&a.reply)return a.newChatSummary&&saveChatSummary(a.newChatSummary),{success:!0,reply:a.reply,crisisLevel:a.crisisLevel,sessionId:a.sessionId,timestamp:a.timestamp};if(a.error||a.message)return{success:!1,message:a.message||a.response||"Error al procesar el mensaje."};throw new Error("Respuesta inesperada del servidor")}catch(e){return console.error("Error en comunicacion con n8n:",e),updateConnectionStatus("error"),{success:!1,message:t("chat_error_connection")}}}function updateConnectionStatus(e){const a=document.getElementById("connection-status");if(a)switch(a.className="",e){case"connected":a.textContent=t("chat_status_ready"),a.classList.add("connected");break;case"processing":a.textContent=t("chat_status_processing");break;case"error":a.textContent=t("chat_status_error"),a.classList.add("error");break;default:a.textContent=t("chat_status_ready")}}function displayBotResponse(e,t){document.getElementById("chat-messages");let a=e;a=a.replace(/\*\*IMPORTANTE\*\*:.*?(112\/911|emergencia|busca ayuda profesional)[^.]*\.?/gi,"").trim(),a=a.replace(/\n\n\s*$/g,"").trim();const s=t||"none";if(window.phaserGame)try{const e=window.phaserGame.scene.keys.EmotionGameScene;e.reactToCrisis(s),e.activeUserBubble&&(e.analyzingAnimation&&(e.analyzingAnimation.stop(),e.analyzingAnimation=null),e.tweens.add({targets:e.activeUserBubble,alpha:0,scale:.5,duration:200,onComplete:()=>{e.activeUserBubble&&(e.activeUserBubble.destroy(),e.activeUserBubble=null)}})),e.chatHistory.push({sender:"bot",message:a,timestamp:(new Date).toISOString(),crisisLevel:s});const t=e.cameras.main.width,r=e.cameras.main.height,i=t<=768,n=t>r&&r<=520;let o,c;o=i?t/2:n?100:t/2,c=i||n?r-80:r-120;const h=c-60,{bubble:l}=e.createSpeechBubble(o,h,a,!1);"emergency"===s||"high_distress"===s?(e.startBreathingExercise(),setTimeout(()=>{e.stopBreathingExercise()},2e4)):e.stopBreathingExercise(),setTimeout(()=>{try{if(e.userInputContainer&&e.userInputContainer.node){const t=e.userInputContainer.node.querySelector(".phaser-chat-input");t&&t.focus()}}catch(e){console.warn("No se pudo hacer focus en el input:",e)}},300)}catch(e){console.error("‚ùå Error al interactuar con Phaser:",e)}else console.warn("‚ö†Ô∏è Phaser game no est√° inicializado");lastBotMessage=a}function displayUserMessage(e){const t=document.getElementById("chat-messages");if(!t)return;const a=document.createElement("div");a.className="chat-message user-message",a.innerHTML=`\n        <div class="message-content">${e}</div>\n        <div class="message-time">${(new Date).toLocaleTimeString(USER_CONTEXT.language,{hour:"2-digit",minute:"2-digit"})}</div>\n    `,t.appendChild(a),t.scrollTop=t.scrollHeight}function showLoading(e=!0){const t=document.getElementById("chat-loading"),a=document.getElementById("chat-send-btn"),s=document.getElementById("chat-input");if(t&&(t.style.display=e?"block":"none"),a&&(a.disabled=e),s&&(s.disabled=e),window.phaserGame)try{const t=window.phaserGame.scene.keys.EmotionGameScene;t&&t.setLoadingState&&t.setLoadingState(e)}catch(e){console.warn("No se pudo actualizar estado de loading en Phaser:",e)}}class EmotionGameScene extends Phaser.Scene{constructor(){super({key:"EmotionGameScene"}),this.character=null,this.clouds=[],this.currentEmotion=null,this.characterParts={},this.ambientParticles=[],this.backgroundGraphics=null,this.breathingCircle=null,this.isBreathingExerciseActive=!1,this.currentCrisisLevel="none",this.activeBubble=null,this.userInputContainer=null,this.chatHistory=[],this.historyModal=null,this.disclaimerBubble=null,this.activeUserBubble=null,this.analyzingAnimation=null,this.loadingProgressBar=null,this.isLoading=!1}create(){this.applySiteScale();const e=this.cameras.main.width/2,t=this.cameras.main.width<=768?.55*this.cameras.main.height:.48*this.cameras.main.height;this.createBackground(),this.createCharacter(e,t),this.createEmotionClouds(e,t),this.createAmbientParticles(),this.createBreathingOverlay(e,t),this.createDisclaimerBubble(),this.showUserInput()}applySiteScale(){const e=this.cameras.main,t=window.__SITE_SCALE||1;e.setZoom(t);const a=e.width/2,s=e.height/2;e.centerOn(a,s),e.setScroll(a-e.width/2,s-e.height/2)}createBackground(){const e=this.cameras.main.width,t=this.cameras.main.height;this.backgroundGraphics=this.add.graphics(),this.updateEnvironment("none");for(let a=0;a<30;a++){const a=Phaser.Math.Between(0,e),s=Phaser.Math.Between(0,t),r=this.add.circle(a,s,Phaser.Math.Between(1,2),16777215,.3);this.tweens.add({targets:r,alpha:{from:.1,to:.5},duration:Phaser.Math.Between(1e3,3e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}updateEnvironment(e){const t=this.cameras.main.width,a=this.cameras.main.height;let s,r,i;switch(this.currentCrisisLevel=e,e){case"emergency":s=4854290,r=2e3,i=.4;break;case"high_distress":s=4004426,r=4e3,i=.3;break;case"ocd_spike":s=1715786,r=6e3,i=.2;break;default:s=4876733,r=1e4,i=.15}this.backgroundGraphics.clear();for(let e=0;e<50;e++){const r=.02,i=15*(50-e);this.backgroundGraphics.fillStyle(s,r),this.backgroundGraphics.fillCircle(t/2,a/2,i)}this.ambientParticles.forEach(e=>{const t=this.tweens.getTweensOf(e)[0];t&&(t.updateTo("duration",Phaser.Math.Between(r,2*r),!0),e.setAlpha(i))})}createCharacter(e,t){this.character=this.add.container(e,t);const a=this.add.graphics();a.fillStyle(7101671,1),a.fillRoundedRect(-40,-30,80,100,20),this.characterParts.body=a;const s=this.add.circle(0,-60,45,16771751);s.setStrokeStyle(3,16632686),this.characterParts.head=s;const r=this.add.graphics();r.fillStyle(2962486,1),r.fillEllipse(0,-95,70,30),r.fillEllipse(-25,-85,25,20),r.fillEllipse(25,-85,25,20),this.characterParts.hair=r;const i=this.add.container(-15,-65),n=this.add.circle(0,0,12,16777215),o=this.add.circle(0,0,6,2962486);i.add([n,o]),this.characterParts.leftEye=i,this.characterParts.leftPupil=o;const c=this.add.container(15,-65),h=this.add.circle(0,0,12,16777215),l=this.add.circle(0,0,6,2962486);c.add([h,l]),this.characterParts.rightEye=c,this.characterParts.rightPupil=l;const d=this.add.rectangle(-15,-82,18,4,2962486);d.setAngle(-5),this.characterParts.leftBrow=d;const u=this.add.rectangle(15,-82,18,4,2962486);u.setAngle(5),this.characterParts.rightBrow=u;const m=this.add.graphics();m.lineStyle(3,2962486),m.beginPath(),m.arc(0,-45,12,0,Math.PI,!1),m.strokePath(),this.characterParts.mouth=m;const g=this.add.rectangle(-55,10,15,50,7101671);g.setAngle(10),this.characterParts.leftArm=g;const p=this.add.rectangle(55,10,15,50,7101671);p.setAngle(-10),this.characterParts.rightArm=p;const y=this.add.circle(-58,35,10,16771751);this.characterParts.leftHand=y;const b=this.add.circle(58,35,10,16771751);this.characterParts.rightHand=b,this.character.add([a,g,p,y,b,s,r,i,c,d,u,m]),this.addIdleAnimation()}addIdleAnimation(){this.tweens.add({targets:this.character,scaleY:1.02,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.time.addEvent({delay:3e3,callback:()=>this.blink(),loop:!0})}blink(){const e=this.characterParts.leftEye.list[0],t=this.characterParts.rightEye.list[0];this.tweens.add({targets:[e,t],scaleY:.1,duration:100,yoyo:!0,ease:"Quad.easeInOut"})}createEmotionClouds(e,t){const a=-Math.PI/2;EMOTIONS.forEach((s,r)=>{const i=a+r*(2*Math.PI/EMOTIONS.length),n=e+170*Math.cos(i),o=t+170*Math.sin(i),c=this.createCloud(n,o,s);this.clouds.push(c)})}createCloud(e,t,a){const s=this.add.container(e,t),r=this.add.graphics();r.fillStyle(16777215,.9),r.fillCircle(0,0,40),r.fillCircle(-25,5,25),r.fillCircle(25,5,25),r.fillCircle(-15,-15,20),r.fillCircle(15,-15,20);const i=this.add.graphics();i.fillStyle(a.color,.3),i.fillCircle(0,0,35);const n=this.add.text(0,0,a.label,{fontSize:"17px",fontFamily:"Segoe UI, system-ui, sans-serif",color:"#2d3436",fontStyle:"bold"}).setOrigin(.5);return s.add([r,i,n]),s.setData("emotion",a),s.setSize(90,70),s.setInteractive({useHandCursor:!0}),s.on("pointerover",()=>{this.tweens.add({targets:s,scale:1.15,duration:200,ease:"Back.easeOut"}),i.clear(),i.fillStyle(a.color,.6),i.fillCircle(0,0,35),this.previewEmotion(a)}),s.on("pointerout",()=>{this.currentEmotion!==a&&(this.tweens.add({targets:s,scale:1,duration:200,ease:"Quad.easeOut"}),i.clear(),i.fillStyle(a.color,.3),i.fillCircle(0,0,35),this.currentEmotion?this.setCharacterEmotion(this.currentEmotion):this.setCharacterNeutral())}),s.on("pointerdown",()=>{this.selectEmotion(a,s)}),this.tweens.add({targets:s,y:t+Phaser.Math.Between(-8,8),duration:Phaser.Math.Between(2e3,3e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut",delay:Phaser.Math.Between(0,1e3)}),s}previewEmotion(e){this.setCharacterEmotion(e)}async selectEmotion(e,a){this.currentEmotion=e,window.currentSelectedEmotion=e,this.tweens.add({targets:a,scale:1.3,duration:150,yoyo:!0,ease:"Quad.easeOut",onComplete:()=>{a.scale=1.15}});const s=document.getElementById("selected-emotion");s&&(s.textContent=`${t("emotion_selected")} ${e.label}`,s.style.display="block"),this.setCharacterEmotion(e),this.disableEmotionClouds();const r=`Me siento ${e.label} (${e.description})`;this.chatHistory.push({sender:"user",message:r,timestamp:(new Date).toISOString()});const i=this.character.x-130,n=this.character.y-60,{bubble:o,secondaryText:c}=this.createSpeechBubble(i,n,r,!0,!0);this.activeUserBubble=o,c&&(this.analyzingAnimation=this.animateAnalyzingDots(c)),showLoading(!0);try{const a=await sendToN8n({message:r,emotion:e});showLoading(!1),a.success&&a.reply?displayBotResponse(a.reply,a.crisisLevel):displayBotResponse(a.message||t("chat_error_generic"),"none")}catch(e){console.error("Error al enviar emoci√≥n:",e),showLoading(!1),displayBotResponse(t("chat_error_generic"),"none")}finally{this.enableEmotionClouds(),this.clouds.forEach(e=>{this.tweens.add({targets:e,scale:1,alpha:1,duration:300})}),s&&(s.style.display="none")}}disableEmotionClouds(){this.clouds.forEach(e=>{e.disableInteractive(),this.tweens.add({targets:e,alpha:.5,duration:200})})}enableEmotionClouds(){this.clouds.forEach(e=>{e.setInteractive({useHandCursor:!0}),this.tweens.add({targets:e,alpha:1,duration:200})})}setCharacterEmotion(e){switch(this.tweens.killTweensOf([this.characterParts.leftBrow,this.characterParts.rightBrow,this.characterParts.leftPupil,this.characterParts.rightPupil,this.characterParts.leftArm,this.characterParts.rightArm,this.character]),this.characterParts.leftBrow.setAngle(-5),this.characterParts.rightBrow.setAngle(5),this.character.setAngle(0),e.key){case"ansioso":this.setAnxiousExpression();break;case"obsesivo":this.setObsessiveExpression();break;case"compulsivo":this.setCompulsiveExpression();break;case"calmado":this.setCalmExpression();break;case"abrumado":this.setOverwhelmedExpression();break;case"controlado":this.setControlledExpression()}}setCharacterNeutral(){this.tweens.killTweensOf([this.characterParts.leftBrow,this.characterParts.rightBrow,this.character]),this.characterParts.leftBrow.setAngle(-5),this.characterParts.rightBrow.setAngle(5),this.character.setAngle(0),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-45,12,0,Math.PI,!1),this.characterParts.mouth.strokePath()}setAnxiousExpression(){this.characterParts.leftBrow.setAngle(15),this.characterParts.rightBrow.setAngle(-15),this.tweens.add({targets:this.character,angle:{from:-2,to:2},duration:100,yoyo:!0,repeat:-1}),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],x:{from:-3,to:3},duration:200,yoyo:!0,repeat:-1}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-40,8,Math.PI,0,!1),this.characterParts.mouth.strokePath()}setObsessiveExpression(){this.characterParts.leftBrow.setAngle(-15),this.characterParts.rightBrow.setAngle(15),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],y:-3,duration:500,yoyo:!0,repeat:-1,ease:"Stepped",easeParams:[2]}),this.tweens.add({targets:this.character,angle:{from:-5,to:5},duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.strokeRect(-8,-48,16,3)}setCompulsiveExpression(){this.characterParts.leftBrow.setAngle(-10),this.characterParts.rightBrow.setAngle(10),this.tweens.add({targets:this.characterParts.leftArm,angle:{from:10,to:30},duration:300,yoyo:!0,repeat:-1}),this.tweens.add({targets:this.characterParts.rightArm,angle:{from:-10,to:-30},duration:300,yoyo:!0,repeat:-1,delay:150}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.fillStyle(2962486,.5),this.characterParts.mouth.fillCircle(0,-45,8)}setCalmExpression(){this.characterParts.leftBrow.setAngle(0),this.characterParts.rightBrow.setAngle(0),this.tweens.add({targets:this.character,y:this.character.y-5,duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],scaleY:.5,duration:1e3,ease:"Sine.easeInOut"}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-50,15,.2,Math.PI-.2,!1),this.characterParts.mouth.strokePath()}setOverwhelmedExpression(){this.characterParts.leftBrow.setAngle(20),this.characterParts.rightBrow.setAngle(-20),this.characterParts.leftBrow.y=-85,this.characterParts.rightBrow.y=-85,this.tweens.add({targets:this.character,angle:{from:-8,to:8},duration:200,yoyo:!0,repeat:-1,ease:"Bounce.easeInOut"}),this.tweens.add({targets:this.characterParts.leftPupil,x:{from:-4,to:4},y:{from:-3,to:3},duration:300,yoyo:!0,repeat:-1}),this.tweens.add({targets:this.characterParts.rightPupil,x:{from:4,to:-4},y:{from:3,to:-3},duration:250,yoyo:!0,repeat:-1}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.fillStyle(2962486,.3),this.characterParts.mouth.fillEllipse(0,-43,15,10)}setControlledExpression(){this.characterParts.leftBrow.setAngle(-3),this.characterParts.rightBrow.setAngle(3),this.tweens.add({targets:this.character,scaleX:1.02,scaleY:1.02,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.characterParts.leftPupil.x=0,this.characterParts.leftPupil.y=0,this.characterParts.rightPupil.x=0,this.characterParts.rightPupil.y=0,this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-48,12,.1,Math.PI-.1,!1),this.characterParts.mouth.strokePath(),this.characterParts.mouth.lineTo(15,-50)}createAmbientParticles(){this.ambientParticles=[];for(let e=0;e<20;e++){const e=Phaser.Math.Between(0,this.cameras.main.width),t=Phaser.Math.Between(0,this.cameras.main.height),a=this.add.circle(e,t,Phaser.Math.Between(2,5),16777215,.15);this.ambientParticles.push(a),this.tweens.add({targets:a,y:t-100,alpha:0,duration:Phaser.Math.Between(5e3,1e4),repeat:-1,onRepeat:()=>{a.x=Phaser.Math.Between(0,this.cameras.main.width),a.y=this.cameras.main.height+20,a.alpha=.15}})}}createBreathingOverlay(e,a){this.breathingCircle=this.add.container(e,a),this.breathingCircle.setAlpha(0);const s=this.add.circle(0,0,100,7101671,.2);s.setStrokeStyle(4,7101671,.5);const r=this.add.circle(0,0,40,7101671,.5),i=this.add.text(0,120,t("breathing_inhale"),{fontSize:"20px",fontFamily:"Segoe UI",color:"#ffffff",backgroundColor:"rgba(0,0,0,0.5)",padding:{x:10,y:5}}).setOrigin(.5);this.breathingCircle.add([s,r,i]),this.breathingCircle.setData("inner",r),this.breathingCircle.setData("text",i)}createDisclaimerBubble(){const e=this.cameras.main.width,a=this.cameras.main.height;let s;s=e<=768?70:e>a&&a<550?50:30;const r={ES:"112",MX:"911",US:"911",CO:"123",AR:"911",PE:"105",CL:"131"}[USER_CONTEXT.countryCode||"ES"]||"112/911",i=t("disclaimer_base").replace("{emergency}",r),n=this.add.text(0,0,i,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"14px",color:"#2d3436",wordWrap:{width:380},lineSpacing:3}),o=n.height,c=n.width;n.destroy();const h=o+20,l=Math.min(c+30,420),d=e-l-20;this.disclaimerBubble=this.add.container(d,s);const u=this.add.graphics();u.fillStyle(16775388,.95),u.lineStyle(2,15158332,1),u.fillRoundedRect(0,0,l,h,12),u.strokeRoundedRect(0,0,l,h,12);const m=this.add.text(15,10,i,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"14px",color:"#2d3436",wordWrap:{width:l-40},lineSpacing:3});this.disclaimerBubble.add([u,m]),this.disclaimerBubble.setAlpha(.9),this.disclaimerBubble.setDepth(50),this.tweens.add({targets:this.disclaimerBubble,y:s+5,duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}startBreathingExercise(){if(this.isBreathingExerciseActive)return;this.isBreathingExerciseActive=!0,this.tweens.add({targets:this.breathingCircle,alpha:1,duration:500});const e=this.breathingCircle.getData("inner"),a=this.breathingCircle.getData("text"),s=this.tweens.chain({targets:e,loop:-1,tweens:[{scale:2.5,duration:4e3,ease:"Sine.easeInOut",onStart:()=>a.setText(t("breathing_inhale"))},{scale:2.5,duration:4e3,onStart:()=>a.setText(t("breathing_hold"))},{scale:1,duration:4e3,ease:"Sine.easeInOut",onStart:()=>a.setText(t("breathing_exhale"))},{scale:1,duration:4e3,onStart:()=>a.setText(t("breathing_pause"))}]});this.breathingCircle.setData("chain",s),this.setGuidingExpression()}stopBreathingExercise(){if(!this.isBreathingExerciseActive)return;this.isBreathingExerciseActive=!1;const e=this.breathingCircle.getData("chain");e&&e.stop(),this.tweens.add({targets:this.breathingCircle,alpha:0,duration:500}),this.setCharacterNeutral()}animateAnalyzingDots(e){if(!e)return{stop:()=>{}};let t=0;const a=this.time.addEvent({delay:400,callback:()=>{t=(t+1)%4;const a=".".repeat(t);e.setText("analizando"+a)},loop:!0});return{stop:()=>{a&&a.remove()}}}createSpeechBubble(e,t,a,s=!1,r=!1){!s&&this.activeBubble&&this.activeBubble.destroy();const i=this.cameras.main.width,n=i<=480,o=n?Math.min(280,i-40):220,c=this.add.text(0,0,a,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:n?"16px":"17px",wordWrap:{width:o-30}});let h=Math.max(60,c.height+30),l=0;if(s&&r){const e=this.add.text(0,0,"analizando...",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"15px"});l=e.height+6,h+=l,e.destroy()}c.destroy();let d=e;if(s){const t=10,a=i-o-10;d=Math.max(t,Math.min(e,a))}else{d=i/2-o/2;const e=10,t=i-o-10;d=Math.max(e,Math.min(d,t))}const u=this.add.container(d,t),m=this.add.graphics();m.fillStyle(16777215,1),m.lineStyle(2,7101671,1),m.fillRoundedRect(0,0,o,h,15),m.strokeRoundedRect(0,0,o,h,15),m.beginPath(),s?(m.moveTo(o-30,h),m.lineTo(o-15,h+15),m.lineTo(o-5,h)):(m.moveTo(o/2-15,h),m.lineTo(o/2,h+15),m.lineTo(o/2+15,h)),m.closePath(),m.fillPath(),m.strokePath();const g=this.add.text(15,15,a,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:n?"16px":"17px",color:"#2d3436",align:"left",wordWrap:{width:o-30}});let p=null;if(s&&r){const e=15+g.height+6;p=this.add.text(15,e,"analizando",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"15px",color:"#0088CC",align:"left",fontStyle:"bold"}),u.add([m,g,p])}else u.add([m,g]);return u.setAlpha(0),u.setScale(.5),this.tweens.add({targets:u,alpha:1,scale:1,y:t-h-15-5,duration:300,ease:"Back.easeOut"}),s||(this.activeBubble=u),{bubble:u,secondaryText:p}}showUserInput(){if(this.userInputContainer)return;const e=this.cameras.main.width,a=this.cameras.main.height,s=e<=768,r=e>a&&a<550;let i,n;i=s?e/2:r?100:e/2,n=s||r?a-80:a-120;const o=`\n            <div class="phaser-input-wrapper">\n                <div class="phaser-loading-bar" style="display: none;">\n                    <div class="phaser-loading-dots">\n                        <span></span><span></span><span></span>\n                    </div>\n                </div>\n                <div class="phaser-input-container">\n                    <button class="phaser-history-btn" title="Ver historial">üìú</button>\n                    <input type="text" class="phaser-chat-input" placeholder="${t("chat_listening")}" />\n                    <button class="phaser-send-btn">${t("chat_send")}</button>\n                </div>\n            </div>\n        `;this.userInputContainer=this.add.dom(i,n).createFromHTML(o);const c=this.userInputContainer.node,h=c.querySelector(".phaser-chat-input"),l=c.querySelector(".phaser-send-btn"),d=c.querySelector(".phaser-history-btn"),u=()=>{const e=h.value.trim();e&&(this.handleUserChat(e),h.value="")};l.addEventListener("click",u),h.addEventListener("keypress",e=>{"Enter"===e.key&&u()}),d.addEventListener("click",()=>{this.showHistoryModal()}),setTimeout(()=>h.focus(),100)}setLoadingState(e){if(!this.userInputContainer)return;this.isLoading=e;const a=this.userInputContainer.node,s=a.querySelector(".phaser-chat-input"),r=a.querySelector(".phaser-send-btn"),i=a.querySelector(".phaser-loading-bar");e?(i&&(i.style.display="flex"),s&&(s.placeholder=t("chat_analyzing"),s.disabled=!0),r&&(r.disabled=!0,r.style.opacity="0.5",r.style.cursor="not-allowed")):(i&&(i.style.display="none"),s&&(s.placeholder=t("chat_listening"),s.disabled=!1),r&&(r.disabled=!1,r.style.opacity="1",r.style.cursor="pointer"))}handleUserChat(e){this.chatHistory.push({sender:"user",message:e,timestamp:(new Date).toISOString()});const t=this.character.x-130,a=this.character.y-60,{bubble:s,secondaryText:r}=this.createSpeechBubble(t,a,e,!0,!0);this.activeUserBubble=s,r&&(this.analyzingAnimation=this.animateAnalyzingDots(r)),window.sendChatMessageFromPhaser(e)}reactToCrisis(e){this.updateEnvironment(e),"emergency"===e||"high_distress"===e?this.setListeningExpression():"none"===e&&this.setCalmExpression()}setListeningExpression(){this.tweens.killTweensOf(this.character),this.tweens.add({targets:this.character,y:this.character.y+10,scaleX:1.05,duration:1e3,ease:"Sine.easeOut"}),this.characterParts.leftBrow.setAngle(10),this.characterParts.rightBrow.setAngle(-10)}setGuidingExpression(){this.tweens.killTweensOf([this.characterParts.leftArm,this.characterParts.rightArm]),this.tweens.add({targets:[this.characterParts.leftArm,this.characterParts.rightArm],angle:{from:10,to:-20},duration:4e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}showHistoryModal(){if(this.historyModal)return;const e=this.cameras.main.width/2,a=this.cameras.main.height/2;this.historyModal=this.add.container(e,a);const s=this.add.graphics();s.fillStyle(0,.7),s.fillRect(-this.cameras.main.width/2,-this.cameras.main.height/2,this.cameras.main.width,this.cameras.main.height),s.setInteractive(new Phaser.Geom.Rectangle(-this.cameras.main.width/2,-this.cameras.main.height/2,this.cameras.main.width,this.cameras.main.height),Phaser.Geom.Rectangle.Contains);const r=this.add.graphics();r.fillStyle(16777215,1),r.lineStyle(3,7101671,1),r.fillRoundedRect(-200,-250,400,500,20),r.strokeRoundedRect(-200,-250,400,500,20);const i=this.add.text(0,-225,t("history_title")||"Historial de Conversaci√≥n",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"20px",fontStyle:"bold",color:"#6c5ce7",align:"center"});i.setOrigin(.5);const n=this.generateHistoryHTML(),o=this.add.dom(0,20).createFromHTML(`\n            <div class="phaser-history-content">\n                ${n}\n            </div>\n        `),c=this.add.text(0,210,t("history_close")||"Cerrar",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"16px",color:"#ffffff",backgroundColor:"#6c5ce7",padding:{x:20,y:10}});c.setOrigin(.5),c.setInteractive({useHandCursor:!0}),c.on("pointerdown",()=>{this.closeHistoryModal()}),c.on("pointerover",()=>{c.setStyle({backgroundColor:"#5a4bc7"})}),c.on("pointerout",()=>{c.setStyle({backgroundColor:"#6c5ce7"})}),this.historyModal.add([s,r,i,o,c]),this.historyModal.setAlpha(0),this.historyModal.setScale(.8),this.tweens.add({targets:this.historyModal,alpha:1,scale:1,duration:300,ease:"Back.easeOut"})}closeHistoryModal(){this.historyModal&&this.tweens.add({targets:this.historyModal,alpha:0,scale:.8,duration:200,ease:"Back.easeIn",onComplete:()=>{this.historyModal.destroy(),this.historyModal=null}})}generateHistoryHTML(){if(0===this.chatHistory.length)return'<p style="text-align: center; color: #999; padding: 20px;">No hay mensajes todav√≠a</p>';let e="";return this.chatHistory.forEach((t,a)=>{const s=new Date(t.timestamp).toLocaleTimeString(USER_CONTEXT.language,{hour:"2-digit",minute:"2-digit"}),r="user"===t.sender?"T√∫":"Asistente",i="user"===t.sender?"history-user":"history-bot",n=t.crisisLevel&&"none"!==t.crisisLevel?`<span class="crisis-tag">${t.crisisLevel}</span>`:"";e+=`\n                <div class="history-entry ${i}">\n                    <div class="history-header">\n                        <strong>${r}</strong> ${n}\n                        <span class="history-time">${s}</span>\n                    </div>\n                    <div class="history-message">${t.message}</div>\n                </div>\n            `}),e}}function initEmotionGame(e="game-container",t=window.innerWidth,a=window.innerHeight){const s={type:Phaser.AUTO,width:t,height:a,parent:e,backgroundColor:"#1a1a2e",dom:{createContainer:!0},scene:EmotionGameScene,scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH}};return new Phaser.Game(s)}window.addEventListener("DOMContentLoaded",async()=>{await detectUserContext(),translateEmotions(),window.phaserGame=initEmotionGame();const e=document.getElementById("chat-input"),a=document.getElementById("chat-send-btn");async function s(a=null){const s=null!==a?a:e.value.trim();if(!s)return;null===a&&e&&(e.value=""),showLoading(!0);let r=s;lastBotMessage&&(r=`[√öltimo mensaje del asistente: "${lastBotMessage}"]\n\nRespuesta del usuario: ${s}`,lastBotMessage=null);try{const e=await sendToN8n({message:r,emotion:null});e.success&&e.reply?displayBotResponse(e.reply,e.crisisLevel):displayBotResponse(e.message||t("chat_error_generic"),"none")}catch(e){console.error("Error inesperado al enviar mensaje:",e),displayBotResponse(t("chat_error_generic"),"none")}finally{showLoading(!1)}}window.sendChatMessageFromPhaser=e=>s(e),a&&a.addEventListener("click",s),e&&e.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),s())})}),window.addEventListener("resize",()=>{window.__SITE_SCALE=getSiteScale(),applySiteScaleToDOM();try{const e=window.phaserGame?.scene?.keys?.EmotionGameScene;e&&"function"==typeof e.applySiteScale&&e.applySiteScale()}catch(e){}}),window.currentSelectedEmotion=null;