function getSiteScale(){const e=window.innerWidth||1024,t=window.innerHeight||768;return e<=480||t<=600||e<=768&&t<=700?.7:1}function applySiteScaleToDOM(){try{document.documentElement.style.setProperty("--site-scale",String(window.__SITE_SCALE))}catch(e){}}window.USER_CONTEXT={countryCode:"ES",language:"es",isSpanishSpeaker:!0},window.__SITE_SCALE=getSiteScale(),applySiteScaleToDOM();const TRANSLATIONS={es:{privacy_title:"üîí Privacidad y Seguridad",privacy_warn:"No compartas informaci√≥n personal identificable",privacy_gdpr:"Procesamos tu mensaje y emoci√≥n seleccionada para proporcionar t√©cnicas de afrontamiento...",privacy_emergency:"No es un servicio de emergencias. Si est√°s en peligro inmediato, contacta: 112 (Espa√±a) o 911 (EE.UU.).",privacy_button:"Entiendo y Acepto",instructions_title:"Soporte en Crisis TOC",instructions_text:"Selecciona una emoci√≥n o escribe un mensaje para recibir apoyo",chat_header:"Asistente TOC",chat_status_ready:"Listo",chat_status_processing:"Procesando...",chat_status_error:"Error",chat_placeholder:"Escribe tu mensaje...",chat_listening:"Estoy aca para escucharte",chat_analyzing:"analizando...",chat_send:"Enviar",chat_welcome:"¬°Hola! Estoy aqu√≠ para apoyarte. Puedes seleccionar una emoci√≥n o escribirme directamente c√≥mo te sientes.",chat_error_connection:"No se pudo conectar con el servicio. Verifica tu conexi√≥n e intenta de nuevo.",chat_error_generic:"Ocurri√≥ un error al procesar tu mensaje. Por favor, intenta de nuevo.",emotion_selected:"Te sientes:",history_title:"Historial de Conversaci√≥n",history_close:"Cerrar",disclaimer_base:"‚ö†Ô∏è No soy un profesional de salud mental. Si est√°s en peligro inmediato o tienes pensamientos de autolesi√≥n, contacta servicios de emergencia ({emergency}) o busca ayuda profesional inmediatamente.",breathing_inhale:"Inhala...",breathing_hold:"Sost√©n...",breathing_exhale:"Exhala...",breathing_pause:"Pausa...",emotions:{ansioso:{label:"Ansioso",desc:"Nerviosismo, preocupaci√≥n"},obsesivo:{label:"Obsesivo",desc:"Pensamientos repetitivos"},compulsivo:{label:"Compulsivo",desc:"Urgencia de actuar"},calmado:{label:"Calmado",desc:"Tranquilidad, paz"},abrumado:{label:"Abrumado",desc:"Sobrecarga, confusi√≥n"},controlado:{label:"Controlado",desc:"Estabilidad, dominio"}}},en:{privacy_title:"üîí Privacy & Security",privacy_warn:"Do not share personally identifiable information",privacy_gdpr:"We process your message and selected emotion to provide coping techniques...",privacy_emergency:"This is NOT an emergency service. If you are in immediate danger, call 911 (USA) or your local emergency number.",privacy_button:"I Understand & Accept",instructions_title:"OCD Crisis Support",instructions_text:"Select an emotion or write a message to receive support",chat_header:"OCD Assistant",chat_status_ready:"Ready",chat_status_processing:"Processing...",chat_status_error:"Error",chat_placeholder:"Type your message...",chat_listening:"I'm here to listen",chat_analyzing:"analyzing...",chat_send:"Send",chat_welcome:"Hello! I am here to support you. You can select an emotion or write directly how you feel.",chat_error_connection:"Could not connect to the service. Please check your connection and try again.",chat_error_generic:"An error occurred while processing your message. Please try again.",emotion_selected:"You feel:",history_title:"Conversation History",history_close:"Close",disclaimer_base:"‚ö†Ô∏è I am not a mental health professional. If you are in immediate danger or have thoughts of self-harm, contact emergency services ({emergency}) or seek professional help immediately.",breathing_inhale:"Inhale...",breathing_hold:"Hold...",breathing_exhale:"Exhale...",breathing_pause:"Pause...",emotions:{ansioso:{label:"Anxious",desc:"Nervousness, worry"},obsesivo:{label:"Obsessive",desc:"Repetitive thoughts"},compulsivo:{label:"Compulsive",desc:"Urge to act"},calmado:{label:"Calm",desc:"Tranquility, peace"},abrumado:{label:"Overwhelmed",desc:"Overload, confusion"},controlado:{label:"Controlled",desc:"Stability, mastery"}}}};async function detectUserContext(){try{const e=(navigator.language||navigator.userLanguage).split("-")[0].toLowerCase(),t=await fetch("https://ipapi.co/json/").catch(()=>null);if(t&&t.ok){const e=await t.json();USER_CONTEXT.countryCode=e.country_code||"ES"}const a=["ES","MX","CO","AR","PE","VE","CL","EC","GT","CU","BO","DO","HN","PY","SV","NI","CR","PR","UY","GQ"];USER_CONTEXT.isSpanishSpeaker=a.includes(USER_CONTEXT.countryCode)||"es"===e,USER_CONTEXT.language=USER_CONTEXT.isSpanishSpeaker?"es":"en",console.log("User context detected:",USER_CONTEXT),applyUITranslations()}catch(e){console.error("Error detecting user context:",e)}}function t(e){const t=USER_CONTEXT.language;return TRANSLATIONS[t][e]||TRANSLATIONS.es[e]||e}function applyUITranslations(){const e=document.querySelector("#privacy-banner h3");e&&(e.textContent=t("privacy_title"));const a=document.querySelector("#privacy-banner button");a&&(a.textContent=t("privacy_button"));const s=document.querySelector("#instructions h3");s&&(s.textContent=t("instructions_title"));const i=document.querySelector("#instructions p");i&&(i.textContent=t("instructions_text"));const r=document.getElementById("chat-header");r&&(document.getElementById("connection-status"),document.getElementById("selected-emotion"),r.childNodes[0].textContent=t("chat_header")+" ");const n=document.getElementById("chat-input");n&&(n.placeholder=t("chat_placeholder"));const o=document.getElementById("chat-send-btn");o&&(o.textContent=t("chat_send"));const c=document.getElementById("chat-messages");if(c&&c.children.length<=1){const e=c.querySelector(".bot-message .message-content");e&&(e.textContent=t("chat_welcome"))}}window.addEventListener("DOMContentLoaded",detectUserContext);const SUMMARY_KEY="toc_chat_summary";function getChatSummary(){return localStorage.getItem(SUMMARY_KEY)||""}function saveChatSummary(e){e&&(localStorage.setItem(SUMMARY_KEY,e),console.log("üß† Memoria IA actualizada:",e))}function clearChatMemory(){localStorage.removeItem(SUMMARY_KEY),console.log("üßπ Memoria IA borrada")}window.clearChatMemory=clearChatMemory;const PRIVACY_KEY="ocd_support_privacy_accepted";function showPrivacyBanner(){const e=document.getElementById("privacy-overlay"),t=document.getElementById("privacy-banner");e&&t&&(e.style.display="block",t.style.display="flex")}function acceptPrivacy(){localStorage.setItem(PRIVACY_KEY,"true");const e=document.getElementById("privacy-overlay"),t=document.getElementById("privacy-banner");e&&t&&(e.style.display="none",t.style.display="none")}function toggleChat(){const e=document.getElementById("chat-panel");e&&e.classList.toggle("minimized")}window.addEventListener("DOMContentLoaded",()=>{localStorage.getItem(PRIVACY_KEY)||showPrivacyBanner()}),window.acceptPrivacy=acceptPrivacy,window.toggleChat=toggleChat;const API_CONFIG={BASE_URL:"https://stivensonunisimon.app.n8n.cloud",WEBHOOK_PATH:"/webhook/webhook-test"};let EMOTIONS=[{key:"ansioso",label:"Ansioso",color:15965202,description:"Nerviosismo, preocupacion"},{key:"obsesivo",label:"Obsesivo",color:10181046,description:"Pensamientos repetitivos"},{key:"compulsivo",label:"Compulsivo",color:15158332,description:"Urgencia de actuar"},{key:"calmado",label:"Calmado",color:3447003,description:"Tranquilidad, paz"},{key:"abrumado",label:"Abrumado",color:15105570,description:"Sobrecarga, confusion"},{key:"controlado",label:"Controlado",color:2600544,description:"Estabilidad, dominio"}];function translateEmotions(){EMOTIONS=EMOTIONS.map(e=>({...e,label:t("emotions")[e.key]?.label||e.label,description:t("emotions")[e.key]?.desc||e.description}))}let lastBotMessage=null;function getSessionId(){let e=localStorage.getItem("toc_support_session_id");return e||(e="web_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("toc_support_session_id",e)),e}async function sendToN8n(e){const a=getSessionId(),s=getChatSummary(),i={sessionId:a,message:e.message||"",emotion:e.emotion||null,timestamp:(new Date).toISOString(),countryCode:USER_CONTEXT.countryCode,language:USER_CONTEXT.language,chatSummary:s};updateConnectionStatus("processing");try{const e=await fetch(API_CONFIG.BASE_URL+API_CONFIG.WEBHOOK_PATH,{method:"POST",headers:{"Content-Type":"application/json","X-Client":"web"},body:JSON.stringify(i)});if(console.log("Response status:",e.status),!e.ok){const t=await e.text();throw console.error("Error response body:",t),new Error(`HTTP ${e.status}: ${t.substring(0,100)}`)}const t=await e.text();let a;try{a=JSON.parse(t)}catch(e){throw console.error("Error parsing JSON:",e),new Error(`Respuesta no es JSON v√°lido: ${t.substring(0,200)}`)}if(updateConnectionStatus("connected"),a.success&&a.reply)return a.newChatSummary&&saveChatSummary(a.newChatSummary),{success:!0,reply:a.reply,crisisLevel:a.crisisLevel,sessionId:a.sessionId,timestamp:a.timestamp};if(a.error||a.message)return{success:!1,message:a.message||a.response||"Error al procesar el mensaje."};throw new Error("Respuesta inesperada del servidor")}catch(e){return console.error("Error en comunicacion con n8n:",e),updateConnectionStatus("error"),{success:!1,message:t("chat_error_connection")}}}function updateConnectionStatus(e){const a=document.getElementById("connection-status");if(a)switch(a.className="",e){case"connected":a.textContent=t("chat_status_ready"),a.classList.add("connected");break;case"processing":a.textContent=t("chat_status_processing");break;case"error":a.textContent=t("chat_status_error"),a.classList.add("error");break;default:a.textContent=t("chat_status_ready")}}function displayBotResponse(e,t){document.getElementById("chat-messages");let a=e;a=a.replace(/\*\*IMPORTANTE\*\*:.*?(112\/911|emergencia|busca ayuda profesional)[^.]*\.?/gi,"").trim(),a=a.replace(/\n\n\s*$/g,"").trim();const s=t||"none";if(window.phaserGame)try{const e=window.phaserGame.scene.keys.EmotionGameScene;let t,i;if(e.reactToCrisis(s),e.activeUserBubble&&(e.analyzingAnimation&&(e.analyzingAnimation.stop(),e.analyzingAnimation=null),e.tweens.add({targets:e.activeUserBubble,alpha:0,scale:.5,duration:200,onComplete:()=>{e.activeUserBubble&&(e.activeUserBubble.destroy(),e.activeUserBubble=null)}})),e.chatHistory.push({sender:"bot",message:a,timestamp:(new Date).toISOString(),crisisLevel:s}),e.userInputContainer){const a=e.cameras.main.zoom||1;t=e.userInputContainer.x,i=e.userInputContainer.y-60/a}else{const a=e.cameras.main.width,s=e.cameras.main.height;t=a/2,i=s-140}const{bubble:r}=e.createSpeechBubble(t,i,a,!1);"emergency"===s||"high_distress"===s?(e.startBreathingExercise(),setTimeout(()=>{e.stopBreathingExercise()},2e4)):e.stopBreathingExercise(),setTimeout(()=>{try{if(e.userInputContainer&&e.userInputContainer.node){const t=e.userInputContainer.node.querySelector(".phaser-chat-input");t&&t.focus()}}catch(e){console.warn("No se pudo hacer focus en el input:",e)}},300)}catch(e){console.error("‚ùå Error al interactuar con Phaser:",e)}else console.warn("‚ö†Ô∏è Phaser game no est√° inicializado");lastBotMessage=a}function displayUserMessage(e){const t=document.getElementById("chat-messages");if(!t)return;const a=document.createElement("div");a.className="chat-message user-message",a.innerHTML=`\n        <div class="message-content">${e}</div>\n        <div class="message-time">${(new Date).toLocaleTimeString(USER_CONTEXT.language,{hour:"2-digit",minute:"2-digit"})}</div>\n    `,t.appendChild(a),t.scrollTop=t.scrollHeight}function showLoading(e=!0){const t=document.getElementById("chat-loading"),a=document.getElementById("chat-send-btn"),s=document.getElementById("chat-input");if(t&&(t.style.display=e?"block":"none"),a&&(a.disabled=e),s&&(s.disabled=e),window.phaserGame)try{const t=window.phaserGame.scene.keys.EmotionGameScene;t&&t.setLoadingState&&t.setLoadingState(e)}catch(e){console.warn("No se pudo actualizar estado de loading en Phaser:",e)}}class EmotionGameScene extends Phaser.Scene{constructor(){super({key:"EmotionGameScene"}),this.character=null,this.clouds=[],this.currentEmotion=null,this.characterParts={},this.ambientParticles=[],this.backgroundGraphics=null,this.breathingCircle=null,this.isBreathingExerciseActive=!1,this.currentCrisisLevel="none",this.activeBubble=null,this.userInputContainer=null,this.chatHistory=[],this.historyModal=null,this.disclaimerBubble=null,this.activeUserBubble=null,this.analyzingAnimation=null,this.loadingProgressBar=null,this.isLoading=!1}create(){this.applySiteScale();const e=this.cameras.main.width/2,t=this.cameras.main.width<=768?.55*this.cameras.main.height:.48*this.cameras.main.height;this.createBackground(),this.createCharacter(e,t),this.createEmotionClouds(e,t),this.createAmbientParticles(),this.createBreathingOverlay(e,t),this.createDisclaimerBubble(),this.showUserInput()}applySiteScale(){const e=this.cameras.main,t=window.__SITE_SCALE||1;e.setZoom(t);const a=e.width/2,s=e.height/2;e.centerOn(a,s),e.setScroll(a-e.width/2,s-e.height/2)}createBackground(){const e=this.cameras.main.width,t=this.cameras.main.height;this.backgroundGraphics=this.add.graphics(),this.updateEnvironment("none");for(let a=0;a<30;a++){const a=Phaser.Math.Between(0,e),s=Phaser.Math.Between(0,t),i=this.add.circle(a,s,Phaser.Math.Between(1,2),16777215,.3);this.tweens.add({targets:i,alpha:{from:.1,to:.5},duration:Phaser.Math.Between(1e3,3e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}updateEnvironment(e){const t=this.cameras.main.width,a=this.cameras.main.height;let s,i,r;switch(this.currentCrisisLevel=e,e){case"emergency":s=4854290,i=2e3,r=.4;break;case"high_distress":s=4004426,i=4e3,r=.3;break;case"ocd_spike":s=1715786,i=6e3,r=.2;break;default:s=4876733,i=1e4,r=.15}this.backgroundGraphics.clear();for(let e=0;e<50;e++){const i=.02,r=15*(50-e);this.backgroundGraphics.fillStyle(s,i),this.backgroundGraphics.fillCircle(t/2,a/2,r)}this.ambientParticles.forEach(e=>{const t=this.tweens.getTweensOf(e)[0];t&&(t.updateTo("duration",Phaser.Math.Between(i,2*i),!0),e.setAlpha(r))})}createCharacter(e,t){this.character=this.add.container(e,t);const a=this.add.graphics();a.fillStyle(7101671,1),a.fillRoundedRect(-40,-30,80,100,20),this.characterParts.body=a;const s=this.add.circle(0,-60,45,16771751);s.setStrokeStyle(3,16632686),this.characterParts.head=s;const i=this.add.graphics();i.fillStyle(2962486,1),i.fillEllipse(0,-95,70,30),i.fillEllipse(-25,-85,25,20),i.fillEllipse(25,-85,25,20),this.characterParts.hair=i;const r=this.add.container(-15,-65),n=this.add.circle(0,0,12,16777215),o=this.add.circle(0,0,6,2962486);r.add([n,o]),this.characterParts.leftEye=r,this.characterParts.leftPupil=o;const c=this.add.container(15,-65),h=this.add.circle(0,0,12,16777215),l=this.add.circle(0,0,6,2962486);c.add([h,l]),this.characterParts.rightEye=c,this.characterParts.rightPupil=l;const d=this.add.rectangle(-15,-82,18,4,2962486);d.setAngle(-5),this.characterParts.leftBrow=d;const u=this.add.rectangle(15,-82,18,4,2962486);u.setAngle(5),this.characterParts.rightBrow=u;const m=this.add.graphics();m.lineStyle(3,2962486),m.beginPath(),m.arc(0,-45,12,0,Math.PI,!1),m.strokePath(),this.characterParts.mouth=m;const g=this.add.rectangle(-55,10,15,50,7101671);g.setAngle(10),this.characterParts.leftArm=g;const p=this.add.rectangle(55,10,15,50,7101671);p.setAngle(-10),this.characterParts.rightArm=p;const y=this.add.circle(-58,35,10,16771751);this.characterParts.leftHand=y;const w=this.add.circle(58,35,10,16771751);this.characterParts.rightHand=w,this.character.add([a,g,p,y,w,s,i,r,c,d,u,m]),this.addIdleAnimation()}addIdleAnimation(){this.tweens.add({targets:this.character,scaleY:1.02,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.time.addEvent({delay:3e3,callback:()=>this.blink(),loop:!0})}blink(){const e=this.characterParts.leftEye.list[0],t=this.characterParts.rightEye.list[0];this.tweens.add({targets:[e,t],scaleY:.1,duration:100,yoyo:!0,ease:"Quad.easeInOut"})}createEmotionClouds(e,t){const a=-Math.PI/2;EMOTIONS.forEach((s,i)=>{const r=a+i*(2*Math.PI/EMOTIONS.length),n=e+170*Math.cos(r),o=t+170*Math.sin(r),c=this.createCloud(n,o,s);this.clouds.push(c)})}createCloud(e,t,a){const s=this.add.container(e,t),i=this.add.graphics();i.fillStyle(16777215,.9),i.fillCircle(0,0,40),i.fillCircle(-25,5,25),i.fillCircle(25,5,25),i.fillCircle(-15,-15,20),i.fillCircle(15,-15,20);const r=this.add.graphics();r.fillStyle(a.color,.3),r.fillCircle(0,0,35);const n=this.add.text(0,0,a.label,{fontSize:"17px",fontFamily:"Segoe UI, system-ui, sans-serif",color:"#2d3436",fontStyle:"bold"}).setOrigin(.5);return s.add([i,r,n]),s.setData("emotion",a),s.setSize(90,70),s.setInteractive({useHandCursor:!0}),s.on("pointerover",()=>{this.tweens.add({targets:s,scale:1.15,duration:200,ease:"Back.easeOut"}),r.clear(),r.fillStyle(a.color,.6),r.fillCircle(0,0,35),this.previewEmotion(a)}),s.on("pointerout",()=>{this.currentEmotion!==a&&(this.tweens.add({targets:s,scale:1,duration:200,ease:"Quad.easeOut"}),r.clear(),r.fillStyle(a.color,.3),r.fillCircle(0,0,35),this.currentEmotion?this.setCharacterEmotion(this.currentEmotion):this.setCharacterNeutral())}),s.on("pointerdown",()=>{this.selectEmotion(a,s)}),this.tweens.add({targets:s,y:t+Phaser.Math.Between(-8,8),duration:Phaser.Math.Between(2e3,3e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut",delay:Phaser.Math.Between(0,1e3)}),s}previewEmotion(e){this.setCharacterEmotion(e)}async selectEmotion(e,a){this.currentEmotion=e,window.currentSelectedEmotion=e,this.tweens.add({targets:a,scale:1.3,duration:150,yoyo:!0,ease:"Quad.easeOut",onComplete:()=>{a.scale=1.15}});const s=document.getElementById("selected-emotion");s&&(s.textContent=`${t("emotion_selected")} ${e.label}`,s.style.display="block"),this.setCharacterEmotion(e),this.disableEmotionClouds();const i=`Me siento ${e.label} (${e.description})`;this.chatHistory.push({sender:"user",message:i,timestamp:(new Date).toISOString()});const r=this.character.x-130,n=this.character.y-60,{bubble:o,secondaryText:c}=this.createSpeechBubble(r,n,i,!0,!0);this.activeUserBubble=o,c&&(this.analyzingAnimation=this.animateAnalyzingDots(c)),showLoading(!0);try{const a=await sendToN8n({message:i,emotion:e});showLoading(!1),a.success&&a.reply?displayBotResponse(a.reply,a.crisisLevel):displayBotResponse(a.message||t("chat_error_generic"),"none")}catch(e){console.error("Error al enviar emoci√≥n:",e),showLoading(!1),displayBotResponse(t("chat_error_generic"),"none")}finally{this.enableEmotionClouds(),this.clouds.forEach(e=>{this.tweens.add({targets:e,scale:1,alpha:1,duration:300})}),s&&(s.style.display="none")}}disableEmotionClouds(){this.clouds.forEach(e=>{e.disableInteractive(),this.tweens.add({targets:e,alpha:.5,duration:200})})}enableEmotionClouds(){this.clouds.forEach(e=>{e.setInteractive({useHandCursor:!0}),this.tweens.add({targets:e,alpha:1,duration:200})})}setCharacterEmotion(e){switch(this.tweens.killTweensOf([this.characterParts.leftBrow,this.characterParts.rightBrow,this.characterParts.leftPupil,this.characterParts.rightPupil,this.characterParts.leftArm,this.characterParts.rightArm,this.character]),this.characterParts.leftBrow.setAngle(-5),this.characterParts.rightBrow.setAngle(5),this.character.setAngle(0),e.key){case"ansioso":this.setAnxiousExpression();break;case"obsesivo":this.setObsessiveExpression();break;case"compulsivo":this.setCompulsiveExpression();break;case"calmado":this.setCalmExpression();break;case"abrumado":this.setOverwhelmedExpression();break;case"controlado":this.setControlledExpression()}}setCharacterNeutral(){this.tweens.killTweensOf([this.characterParts.leftBrow,this.characterParts.rightBrow,this.character]),this.characterParts.leftBrow.setAngle(-5),this.characterParts.rightBrow.setAngle(5),this.character.setAngle(0),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-45,12,0,Math.PI,!1),this.characterParts.mouth.strokePath()}setAnxiousExpression(){this.characterParts.leftBrow.setAngle(15),this.characterParts.rightBrow.setAngle(-15),this.tweens.add({targets:this.character,angle:{from:-2,to:2},duration:100,yoyo:!0,repeat:-1}),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],x:{from:-3,to:3},duration:200,yoyo:!0,repeat:-1}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-40,8,Math.PI,0,!1),this.characterParts.mouth.strokePath()}setObsessiveExpression(){this.characterParts.leftBrow.setAngle(-15),this.characterParts.rightBrow.setAngle(15),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],y:-3,duration:500,yoyo:!0,repeat:-1,ease:"Stepped",easeParams:[2]}),this.tweens.add({targets:this.character,angle:{from:-5,to:5},duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.strokeRect(-8,-48,16,3)}setCompulsiveExpression(){this.characterParts.leftBrow.setAngle(-10),this.characterParts.rightBrow.setAngle(10),this.tweens.add({targets:this.characterParts.leftArm,angle:{from:10,to:30},duration:300,yoyo:!0,repeat:-1}),this.tweens.add({targets:this.characterParts.rightArm,angle:{from:-10,to:-30},duration:300,yoyo:!0,repeat:-1,delay:150}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.fillStyle(2962486,.5),this.characterParts.mouth.fillCircle(0,-45,8)}setCalmExpression(){this.characterParts.leftBrow.setAngle(0),this.characterParts.rightBrow.setAngle(0),this.tweens.add({targets:this.character,y:this.character.y-5,duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.tweens.add({targets:[this.characterParts.leftPupil,this.characterParts.rightPupil],scaleY:.5,duration:1e3,ease:"Sine.easeInOut"}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-50,15,.2,Math.PI-.2,!1),this.characterParts.mouth.strokePath()}setOverwhelmedExpression(){this.characterParts.leftBrow.setAngle(20),this.characterParts.rightBrow.setAngle(-20),this.characterParts.leftBrow.y=-85,this.characterParts.rightBrow.y=-85,this.tweens.add({targets:this.character,angle:{from:-8,to:8},duration:200,yoyo:!0,repeat:-1,ease:"Bounce.easeInOut"}),this.tweens.add({targets:this.characterParts.leftPupil,x:{from:-4,to:4},y:{from:-3,to:3},duration:300,yoyo:!0,repeat:-1}),this.tweens.add({targets:this.characterParts.rightPupil,x:{from:4,to:-4},y:{from:3,to:-3},duration:250,yoyo:!0,repeat:-1}),this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.fillStyle(2962486,.3),this.characterParts.mouth.fillEllipse(0,-43,15,10)}setControlledExpression(){this.characterParts.leftBrow.setAngle(-3),this.characterParts.rightBrow.setAngle(3),this.tweens.add({targets:this.character,scaleX:1.02,scaleY:1.02,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.characterParts.leftPupil.x=0,this.characterParts.leftPupil.y=0,this.characterParts.rightPupil.x=0,this.characterParts.rightPupil.y=0,this.characterParts.mouth.clear(),this.characterParts.mouth.lineStyle(3,2962486),this.characterParts.mouth.beginPath(),this.characterParts.mouth.arc(0,-48,12,.1,Math.PI-.1,!1),this.characterParts.mouth.strokePath(),this.characterParts.mouth.lineTo(15,-50)}createAmbientParticles(){this.ambientParticles=[];for(let e=0;e<20;e++){const e=Phaser.Math.Between(0,this.cameras.main.width),t=Phaser.Math.Between(0,this.cameras.main.height),a=this.add.circle(e,t,Phaser.Math.Between(2,5),16777215,.15);this.ambientParticles.push(a),this.tweens.add({targets:a,y:t-100,alpha:0,duration:Phaser.Math.Between(5e3,1e4),repeat:-1,onRepeat:()=>{a.x=Phaser.Math.Between(0,this.cameras.main.width),a.y=this.cameras.main.height+20,a.alpha=.15}})}}createBreathingOverlay(e,a){this.breathingCircle=this.add.container(e,a),this.breathingCircle.setAlpha(0);const s=this.add.circle(0,0,100,7101671,.2);s.setStrokeStyle(4,7101671,.5);const i=this.add.circle(0,0,40,7101671,.5),r=this.add.text(0,120,t("breathing_inhale"),{fontSize:"20px",fontFamily:"Segoe UI",color:"#ffffff",backgroundColor:"rgba(0,0,0,0.5)",padding:{x:10,y:5}}).setOrigin(.5);this.breathingCircle.add([s,i,r]),this.breathingCircle.setData("inner",i),this.breathingCircle.setData("text",r)}createDisclaimerBubble(){const e=this.cameras.main,a={ES:"112",MX:"911",US:"911",CO:"123",AR:"911",PE:"105",CL:"131"}[USER_CONTEXT.countryCode||"ES"]||"112/911",s=t("disclaimer_base").replace("{emergency}",a),i=this.sys?.game?.canvas?.getBoundingClientRect?.(),r="undefined"!=typeof window&&window.visualViewport?window.visualViewport:null,n=i&&i.width?i.width:r&&r.width?r.width:"undefined"!=typeof window&&window.innerWidth||e.width,o=(i&&i.height?i.height:r&&r.height?r.height:"undefined"!=typeof window&&window.innerHeight||e.height,e.zoom||1),c="undefined"!=typeof document?document.getElementById("app-title"):null,h=c?c.getBoundingClientRect().height:50,l=n-20-20,d=n<=420?280:420,u=Math.min(d,l),m=this.add.text(0,0,s,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"14px",color:"#2d3436",wordWrap:{width:u-40},lineSpacing:3}),g=m.height,p=m.width;m.destroy();const y=g+20,w=Math.min(p+30,u),f=n-20-w,b=h+10;let S=e.scrollX+f/o,E=e.scrollY+b/o;const P=e.scrollX+20/o,C=e.scrollX+n/o-w-20/o;S=Math.max(P,Math.min(S,C)),this.disclaimerBubble=this.add.container(S,E);const v=this.add.graphics();v.fillStyle(16775388,.95),v.lineStyle(2,15158332,1),v.fillRoundedRect(0,0,w,y,12),v.strokeRoundedRect(0,0,w,y,12);const _=this.add.text(15,10,s,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"14px",color:"#2d3436",wordWrap:{width:w-40},lineSpacing:3});this.disclaimerBubble.add([v,_]),this.disclaimerBubble.setAlpha(.9),this.disclaimerBubble.setDepth(50),this.tweens.add({targets:this.disclaimerBubble,y:E+5/o,duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}startBreathingExercise(){if(this.isBreathingExerciseActive)return;this.isBreathingExerciseActive=!0,this.tweens.add({targets:this.breathingCircle,alpha:1,duration:500});const e=this.breathingCircle.getData("inner"),a=this.breathingCircle.getData("text"),s=this.tweens.chain({targets:e,loop:-1,tweens:[{scale:2.5,duration:4e3,ease:"Sine.easeInOut",onStart:()=>a.setText(t("breathing_inhale"))},{scale:2.5,duration:4e3,onStart:()=>a.setText(t("breathing_hold"))},{scale:1,duration:4e3,ease:"Sine.easeInOut",onStart:()=>a.setText(t("breathing_exhale"))},{scale:1,duration:4e3,onStart:()=>a.setText(t("breathing_pause"))}]});this.breathingCircle.setData("chain",s),this.setGuidingExpression()}stopBreathingExercise(){if(!this.isBreathingExerciseActive)return;this.isBreathingExerciseActive=!1;const e=this.breathingCircle.getData("chain");e&&e.stop(),this.tweens.add({targets:this.breathingCircle,alpha:0,duration:500}),this.setCharacterNeutral()}animateAnalyzingDots(e){if(!e)return{stop:()=>{}};let t=0;const a=this.time.addEvent({delay:400,callback:()=>{t=(t+1)%4;const a=".".repeat(t);e.setText("analizando"+a)},loop:!0});return{stop:()=>{a&&a.remove()}}}createSpeechBubble(e,t,a,s=!1,i=!1){!s&&this.activeBubble&&this.activeBubble.destroy();const r=this.cameras.main.width,n=r<=480,o=n?Math.min(280,r-40):220,c=this.add.text(0,0,a,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:n?"16px":"17px",wordWrap:{width:o-30}});let h=Math.max(60,c.height+30),l=0;if(s&&i){const e=this.add.text(0,0,"analizando...",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"15px"});l=e.height+6,h+=l,e.destroy()}c.destroy();let d=e;if(s){const t=10,a=r-o-10;d=Math.max(t,Math.min(e,a))}else{d=r/2-o/2;const e=10,t=r-o-10;d=Math.max(e,Math.min(d,t))}const u=this.add.container(d,t),m=this.add.graphics();m.fillStyle(16777215,1),m.lineStyle(2,7101671,1),m.fillRoundedRect(0,0,o,h,15),m.strokeRoundedRect(0,0,o,h,15),m.beginPath(),s?(m.moveTo(o-30,h),m.lineTo(o-15,h+15),m.lineTo(o-5,h)):(m.moveTo(o/2-15,h),m.lineTo(o/2,h+15),m.lineTo(o/2+15,h)),m.closePath(),m.fillPath(),m.strokePath();const g=this.add.text(15,15,a,{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:n?"16px":"17px",color:"#2d3436",align:"left",wordWrap:{width:o-30}});let p=null;if(s&&i){const e=15+g.height+6;p=this.add.text(15,e,"analizando",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"15px",color:"#0088CC",align:"left",fontStyle:"bold"}),u.add([m,g,p])}else u.add([m,g]);return u.setAlpha(0),u.setScale(.5),this.tweens.add({targets:u,alpha:1,scale:1,y:t-h-15-5,duration:300,ease:"Back.easeOut"}),s||(this.activeBubble=u),{bubble:u,secondaryText:p}}showUserInput(){const e=()=>{const e=this.cameras.main,t=e.width,a=e.height,s=this.sys?.game?.canvas?.getBoundingClientRect?.(),i="undefined"!=typeof window&&window.visualViewport?window.visualViewport:null,r=s&&s.width?s.width:i&&i.width?i.width:"undefined"!=typeof window&&window.innerWidth||t,n=s&&s.height?s.height:i&&i.height?i.height:"undefined"!=typeof window&&window.innerHeight||a,o=r<=768,c=r>n&&n<550,h=e.zoom||1;if(c){let t=350,a=56;if(this.userInputContainer&&this.userInputContainer.node)try{const e=this.userInputContainer.node.getBoundingClientRect();e.width>0&&(t=e.width),e.height>0&&(a=e.height)}catch(e){}const s=20,i=10;let r=50;try{const e="undefined"!=typeof document?document.getElementById("footer"):null;if(e){const t=e.getBoundingClientRect();t&&t.height&&(r=t.height)}}catch(e){}const o=s+t/2,c=n-r-i-a/2;return{centerX:e.scrollX+o/h,centerY:e.scrollY+c/h}}return{centerX:t/2,centerY:o?a-80:a-120}};if(this.userInputContainer){const{centerX:t,centerY:a}=e();return void this.userInputContainer.setPosition(t,a)}const{centerX:a,centerY:s}=e(),i=`\n            <div class="phaser-input-wrapper">\n                <div class="phaser-loading-bar" style="display: none;">\n                    <div class="phaser-loading-dots">\n                        <span></span><span></span><span></span>\n                    </div>\n                </div>\n                <div class="phaser-input-container">\n                    <button class="phaser-history-btn" title="Ver historial">üìú</button>\n                    <input type="text" class="phaser-chat-input" placeholder="${t("chat_listening")}" />\n                    <button class="phaser-send-btn">${t("chat_send")}</button>\n                </div>\n            </div>\n        `;this.userInputContainer=this.add.dom(a,s).createFromHTML(i);const r=this.userInputContainer.node,n=r.querySelector(".phaser-chat-input"),o=r.querySelector(".phaser-send-btn"),c=r.querySelector(".phaser-history-btn"),h=()=>{const e=n.value.trim();e&&(this.handleUserChat(e),n.value="")};o.addEventListener("click",h),n.addEventListener("keypress",e=>{"Enter"===e.key&&h()}),c.addEventListener("click",()=>{this.showHistoryModal()}),setTimeout(()=>n.focus(),100)}updateResponsiveLayout(){try{this.showUserInput()}catch(e){}try{if(this.disclaimerBubble){const e=this.cameras.main,t=this.sys?.game?.canvas?.getBoundingClientRect?.(),a="undefined"!=typeof window&&window.visualViewport?window.visualViewport:null,s=t&&t.width?t.width:a&&a.width?a.width:"undefined"!=typeof window&&window.innerWidth||e.width,i=e.zoom||1,r="undefined"!=typeof document?document.getElementById("app-title"):null,n=r?r.getBoundingClientRect().height:50,o=10,c=20,h=20,l=this.disclaimerBubble.getBounds(),d=l?.width||0,u=s-c-d,m=n+o;let g=e.scrollX+u/i,p=e.scrollY+m/i;const y=e.scrollX+h/i,w=e.scrollX+s/i-d-c/i;g=Math.max(y,Math.min(g,w)),this.disclaimerBubble.setPosition(g,p)}}catch(e){}}setLoadingState(e){if(!this.userInputContainer)return;this.isLoading=e;const a=this.userInputContainer.node,s=a.querySelector(".phaser-chat-input"),i=a.querySelector(".phaser-send-btn"),r=a.querySelector(".phaser-loading-bar");e?(r&&(r.style.display="flex"),s&&(s.placeholder=t("chat_analyzing"),s.disabled=!0),i&&(i.disabled=!0,i.style.opacity="0.5",i.style.cursor="not-allowed")):(r&&(r.style.display="none"),s&&(s.placeholder=t("chat_listening"),s.disabled=!1),i&&(i.disabled=!1,i.style.opacity="1",i.style.cursor="pointer"))}handleUserChat(e){this.chatHistory.push({sender:"user",message:e,timestamp:(new Date).toISOString()});const t=this.character.x-130,a=this.character.y-60,{bubble:s,secondaryText:i}=this.createSpeechBubble(t,a,e,!0,!0);this.activeUserBubble=s,i&&(this.analyzingAnimation=this.animateAnalyzingDots(i)),window.sendChatMessageFromPhaser(e)}reactToCrisis(e){this.updateEnvironment(e),"emergency"===e||"high_distress"===e?this.setListeningExpression():"none"===e&&this.setCalmExpression()}setListeningExpression(){this.tweens.killTweensOf(this.character),this.tweens.add({targets:this.character,y:this.character.y+10,scaleX:1.05,duration:1e3,ease:"Sine.easeOut"}),this.characterParts.leftBrow.setAngle(10),this.characterParts.rightBrow.setAngle(-10)}setGuidingExpression(){this.tweens.killTweensOf([this.characterParts.leftArm,this.characterParts.rightArm]),this.tweens.add({targets:[this.characterParts.leftArm,this.characterParts.rightArm],angle:{from:10,to:-20},duration:4e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}showHistoryModal(){if(this.historyModal)return;const e=this.cameras.main.width/2,a=this.cameras.main.height/2;this.historyModal=this.add.container(e,a);const s=this.add.graphics();s.fillStyle(0,.7),s.fillRect(-this.cameras.main.width/2,-this.cameras.main.height/2,this.cameras.main.width,this.cameras.main.height),s.setInteractive(new Phaser.Geom.Rectangle(-this.cameras.main.width/2,-this.cameras.main.height/2,this.cameras.main.width,this.cameras.main.height),Phaser.Geom.Rectangle.Contains);const i=this.add.graphics();i.fillStyle(16777215,1),i.lineStyle(3,7101671,1),i.fillRoundedRect(-200,-250,400,500,20),i.strokeRoundedRect(-200,-250,400,500,20);const r=this.add.text(0,-225,t("history_title")||"Historial de Conversaci√≥n",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"20px",fontStyle:"bold",color:"#6c5ce7",align:"center"});r.setOrigin(.5);const n=this.generateHistoryHTML(),o=this.add.dom(0,20).createFromHTML(`\n            <div class="phaser-history-content">\n                ${n}\n            </div>\n        `),c=this.add.text(0,210,t("history_close")||"Cerrar",{fontFamily:"Segoe UI, system-ui, sans-serif",fontSize:"16px",color:"#ffffff",backgroundColor:"#6c5ce7",padding:{x:20,y:10}});c.setOrigin(.5),c.setInteractive({useHandCursor:!0}),c.on("pointerdown",()=>{this.closeHistoryModal()}),c.on("pointerover",()=>{c.setStyle({backgroundColor:"#5a4bc7"})}),c.on("pointerout",()=>{c.setStyle({backgroundColor:"#6c5ce7"})}),this.historyModal.add([s,i,r,o,c]),this.historyModal.setAlpha(0),this.historyModal.setScale(.8),this.tweens.add({targets:this.historyModal,alpha:1,scale:1,duration:300,ease:"Back.easeOut"})}closeHistoryModal(){this.historyModal&&this.tweens.add({targets:this.historyModal,alpha:0,scale:.8,duration:200,ease:"Back.easeIn",onComplete:()=>{this.historyModal.destroy(),this.historyModal=null}})}generateHistoryHTML(){if(0===this.chatHistory.length)return'<p style="text-align: center; color: #999; padding: 20px;">No hay mensajes todav√≠a</p>';let e="";return this.chatHistory.forEach((t,a)=>{const s=new Date(t.timestamp).toLocaleTimeString(USER_CONTEXT.language,{hour:"2-digit",minute:"2-digit"}),i="user"===t.sender?"T√∫":"Asistente",r="user"===t.sender?"history-user":"history-bot",n=t.crisisLevel&&"none"!==t.crisisLevel?`<span class="crisis-tag">${t.crisisLevel}</span>`:"";e+=`\n                <div class="history-entry ${r}">\n                    <div class="history-header">\n                        <strong>${i}</strong> ${n}\n                        <span class="history-time">${s}</span>\n                    </div>\n                    <div class="history-message">${t.message}</div>\n                </div>\n            `}),e}}function initEmotionGame(e="game-container",t=window.innerWidth,a=window.innerHeight){const s={type:Phaser.AUTO,width:t,height:a,parent:e,backgroundColor:"#1a1a2e",dom:{createContainer:!0},scene:EmotionGameScene,scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH}};return new Phaser.Game(s)}window.addEventListener("DOMContentLoaded",async()=>{await detectUserContext(),translateEmotions(),window.phaserGame=initEmotionGame();const e=document.getElementById("chat-input"),a=document.getElementById("chat-send-btn");async function s(a=null){const s=null!==a?a:e.value.trim();if(!s)return;null===a&&e&&(e.value=""),showLoading(!0);let i=s;lastBotMessage&&(i=`[√öltimo mensaje del asistente: "${lastBotMessage}"]\n\nRespuesta del usuario: ${s}`,lastBotMessage=null);try{const e=await sendToN8n({message:i,emotion:null});e.success&&e.reply?displayBotResponse(e.reply,e.crisisLevel):displayBotResponse(e.message||t("chat_error_generic"),"none")}catch(e){console.error("Error inesperado al enviar mensaje:",e),displayBotResponse(t("chat_error_generic"),"none")}finally{showLoading(!1)}}window.sendChatMessageFromPhaser=e=>s(e),a&&a.addEventListener("click",s),e&&e.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),s())})}),window.addEventListener("resize",()=>{window.__SITE_SCALE=getSiteScale(),applySiteScaleToDOM();try{const e=window.phaserGame?.scene?.keys?.EmotionGameScene;e&&"function"==typeof e.applySiteScale&&e.applySiteScale(),e&&"function"==typeof e.updateResponsiveLayout&&e.updateResponsiveLayout()}catch(e){}});try{window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{try{const e=window.phaserGame?.scene?.keys?.EmotionGameScene;e&&"function"==typeof e.updateResponsiveLayout&&e.updateResponsiveLayout()}catch(e){}})}catch(e){}window.currentSelectedEmotion=null;